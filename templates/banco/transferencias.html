{% extends "base.html" %}
{% block title %}Transferencias Bancarias - CalculAI{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
<style>
    .modal {
        transition: opacity 0.25s ease;
    }
    body.modal-active {
        overflow-x: hidden;
        overflow-y: visible !important;
    }
    .select2-container .select2-selection--single {
        height: 38px;
        line-height: 38px;
    }
    .select2-container--default .select2-selection--single {
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 38px;
        padding-left: 12px;
        color: #4a5568;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
    }
    .animate__animated {
        --animate-duration: 0.5s;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex">
    <!-- Sidebar -->
    <div class="w-64 bg-gray-800 min-h-screen p-4">
        <h2 class="text-white text-xl font-semibold mb-4">Módulos</h2>
        <nav>
            <ul>
                {% for modulo in modulos %}
                <li class="mb-2">
                    <a href="{{ url_for(modulo.url) }}" class="text-gray-300 hover:text-white block py-2 px-4 rounded {% if modulo.active %}bg-gray-700{% endif %}">
                        <i class="{{ modulo.icon }} mr-2"></i>{{ modulo.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-8">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 animate__animated animate__fadeIn">Transferencias Bancarias</h1>
        
        <div class="mb-6 flex justify-between items-center animate__animated animate__fadeInUp">
            <button id="crear-transferencia-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                <i class="fas fa-plus mr-2"></i>Crear Nueva Transferencia
            </button>
            <div class="flex space-x-2">
                <input type="text" id="buscar" placeholder="Buscar..." class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="buscar-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <div class="bg-white shadow-lg rounded-lg overflow-hidden animate__animated animate__fadeInUp animate__delay-1s">
            <table class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Banco Origen
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Banco Destino
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Monto
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Fecha
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Descripción
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Acciones
                        </th>
                    </tr>
                </thead>
                <tbody id="transferencias-body">
                    {% for transferencia in transferencias %}
                    <tr>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            {{ transferencia.banco_origen.nombre }}
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            {{ transferencia.banco_destino.nombre }}
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            ${{ "{:,.2f}".format(transferencia.monto) }}
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            {{ transferencia.fecha.strftime('%d/%m/%Y') }}
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            {{ transferencia.descripcion }}
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <button class="editar-transferencia text-blue-600 hover:text-blue-900 mr-2 transition duration-300 ease-in-out" data-id="{{ transferencia.id }}">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="eliminar-transferencia text-red-600 hover:text-red-900 transition duration-300 ease-in-out" data-id="{{ transferencia.id }}">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-6 flex justify-between items-center animate__animated animate__fadeInUp animate__delay-2s">
            <div>
                <span class="text-gray-600">Mostrando <span id="items-showing" class="font-semibold">0</span> de <span id="total-items" class="font-semibold">0</span> transferencias</span>
            </div>
            <div class="space-x-2">
                <button id="prev-page" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">Anterior</button>
                <button id="next-page" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">Siguiente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar transferencia -->
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    
    <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
        <div class="modal-content py-4 text-left px-6">
            <div class="flex justify-between items-center pb-3">
                <p class="text-2xl font-bold" id="modal-title">Crear Transferencia</p>
                <div class="modal-close cursor-pointer z-50">
                    <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                        <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                    </svg>
                </div>
            </div>

            <form id="transferencia-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="banco_origen">
                        Banco Origen
                    </label>
                    <select id="banco_origen" name="banco_origen" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Seleccione un banco</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="banco_destino">
                        Banco Destino
                    </label>
                    <select id="banco_destino" name="banco_destino" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Seleccione un banco</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="monto">
                        Monto
                    </label>
                    <input type="number" id="monto" name="monto" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" step="0.01" min="0" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="fecha">
                        Fecha
                    </label>
                    <input type="text" id="fecha" name="fecha" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="descripcion">
                        Descripción
                    </label>
                    <textarea id="descripcion" name="descripcion" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3"></textarea>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 ease-in-out">
                        Guardar
                    </button>
                    <button type="button" class="modal-close bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 ease-in-out">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const crearTransferenciaBtn = document.getElementById('crear-transferencia-btn');
    const modal = document.querySelector('.modal');
    const transferenciasBody = document.getElementById('transferencias-body');
    const transferenciaForm = document.getElementById('transferencia-form');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');

    let currentPage = 1;
    const itemsPerPage = 10;

    crearTransferenciaBtn.addEventListener('click', () => showModal('Crear Transferencia'));
    transferenciaForm.addEventListener('submit', handleSubmit);
    prevPageBtn.addEventListener('click', () => changePage(-1));
    nextPageBtn.addEventListener('click', () => changePage(1));

    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', hideModal);
    });

    flatpickr("#fecha", {
        dateFormat: "Y-m-d",
    });

    $('#banco_origen, #banco_destino').select2({
        placeholder: "Seleccione un banco",
        allowClear: true,
        dropdownParent: $('.modal-container')
    });

    loadBancos();
    loadTransferencias();

    function showModal(title) {
        document.getElementById('modal-title').textContent = title;
        modal.classList.remove('opacity-0', 'pointer-events-none');
        document.body.classList.add('modal-active');
    }

    function hideModal() {
        modal.classList.add('opacity-0', 'pointer-events-none');
        document.body.classList.remove('modal-active');
    transferenciaForm.reset();
    $('#banco_origen, #banco_destino').val(null).trigger('change');
}

function loadBancos() {
    fetch('/api/bancos')
        .then(response => response.json())
        .then(bancos => {
            const options = bancos.map(banco => 
                `<option value="${banco.id}">${banco.nombre}</option>`
            ).join('');
            document.getElementById('banco_origen').innerHTML += options;
            document.getElementById('banco_destino').innerHTML += options;
            $('#banco_origen, #banco_destino').trigger('change');
        })
        .catch(error => console.error('Error cargando bancos:', error));
}

function loadTransferencias() {
    fetch(`/api/transferencias?page=${currentPage}&per_page=${itemsPerPage}`)
        .then(response => response.json())
        .then(data => {
            updateTable(data.transferencias);
            updatePagination(data.total, data.page, data.per_page);
        })
        .catch(error => console.error('Error cargando transferencias:', error));
}

function updateTable(transferencias) {
    transferenciasBody.innerHTML = transferencias.map(t => `
        <tr>
            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                ${t.banco_origen.nombre}
            </td>
            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                ${t.banco_destino.nombre}
            </td>
            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                $${t.monto.toFixed(2)}
            </td>
            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                ${new Date(t.fecha).toLocaleDateString()}
            </td>
            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                ${t.descripcion}
            </td>
            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                <button class="editar-transferencia text-blue-600 hover:text-blue-900 mr-2 transition duration-300 ease-in-out" data-id="${t.id}">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button class="eliminar-transferencia text-red-600 hover:text-red-900 transition duration-300 ease-in-out" data-id="${t.id}">
                    <i class="fas fa-trash-alt"></i> Eliminar
                </button>
            </td>
        </tr>
    `).join('');

    document.querySelectorAll('.editar-transferencia').forEach(btn => {
        btn.addEventListener('click', () => editarTransferencia(btn.dataset.id));
    });

    document.querySelectorAll('.eliminar-transferencia').forEach(btn => {
        btn.addEventListener('click', () => eliminarTransferencia(btn.dataset.id));
    });
}

function updatePagination(total, page, perPage) {
    const totalPages = Math.ceil(total / perPage);
    document.getElementById('items-showing').textContent = `${(page - 1) * perPage + 1}-${Math.min(page * perPage, total)}`;
    document.getElementById('total-items').textContent = total;
    prevPageBtn.disabled = page === 1;
    nextPageBtn.disabled = page === totalPages;
    prevPageBtn.classList.toggle('opacity-50', page === 1);
    nextPageBtn.classList.toggle('opacity-50', page === totalPages);
}

function changePage(direction) {
    currentPage += direction;
    loadTransferencias();
}

function handleSubmit(e) {
    e.preventDefault();
    const formData = new FormData(transferenciaForm);
    const transferenciaData = Object.fromEntries(formData.entries());
    const transferenciaId = transferenciaForm.dataset.id;

    const url = transferenciaId 
        ? `/api/transferencias/${transferenciaId}` 
        : '/api/transferencias';
    const method = transferenciaId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(transferenciaData),
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        Swal.fire({
            icon: 'success',
            title: 'Éxito',
            text: transferenciaId ? 'Transferencia actualizada correctamente' : 'Transferencia creada correctamente',
        });
        hideModal();
        loadTransferencias();
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Hubo un error al procesar la transferencia',
        });
    });
}

function editarTransferencia(id) {
    fetch(`/api/transferencias/${id}`)
        .then(response => response.json())
        .then(transferencia => {
            transferenciaForm.dataset.id = transferencia.id;
            document.getElementById('banco_origen').value = transferencia.banco_origen_id;
            document.getElementById('banco_destino').value = transferencia.banco_destino_id;
            document.getElementById('monto').value = transferencia.monto;
            document.getElementById('fecha').value = transferencia.fecha;
            document.getElementById('descripcion').value = transferencia.descripcion;
            $('#banco_origen, #banco_destino').trigger('change');
            showModal('Editar Transferencia');
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo cargar la información de la transferencia',
            });
        });
}

function eliminarTransferencia(id) {
    Swal.fire({
        title: '¿Estás seguro?',
        text: "No podrás revertir esta acción",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/api/transferencias/${id}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                Swal.fire(
                    'Eliminado',
                    'La transferencia ha sido eliminada.',
                    'success'
                );
                loadTransferencias();
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Hubo un error al eliminar la transferencia',
                });
            });
        }
    });
}

// Inicialización de componentes y eventos adicionales
const buscarInput = document.getElementById('buscar');
const buscarBtn = document.getElementById('buscar-btn');

buscarBtn.addEventListener('click', () => {
    const searchTerm = buscarInput.value.trim();
    if (searchTerm) {
        // Implementar la lógica de búsqueda aquí
        console.log('Búsqueda:', searchTerm);
    }
});

buscarInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        buscarBtn.click();
    }
});

});
</script>
{% endblock %}