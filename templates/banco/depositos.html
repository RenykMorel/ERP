{% extends "base.html" %}
{% block title %}Gestión de Depósitos - CalculAI{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<style>
    .custom-shadow {
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Gestión de Depósitos</h1>
    
    <div class="mb-6 flex flex-wrap items-center justify-between">
        <button id="crear-deposito-btn" class="bg-black text-white font-bold py-2 px-4 rounded">
            + Crear Nuevo Depósito
        </button>
        <div class="flex flex-wrap items-center space-x-2 mt-4 sm:mt-0">
            <select id="filtro-banco" class="border rounded px-2 py-1">
                <option value="">Todos los bancos</option>
                <option>Banco A</option>
                <option>Banco B</option>
                <option>Banco C</option>
            </select>
            <input type="text" id="filtro-fecha" placeholder="mm/dd/yyyy" class="border rounded px-2 py-1">
            <button id="aplicar-filtros-btn" class="bg-gray-200 text-gray-800 font-bold py-1 px-4 rounded">
                Aplicar Filtros
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded custom-shadow">
            <h2 class="text-lg font-semibold mb-2">Total Depósitos</h2>
            <p class="text-3xl font-bold text-blue-500" id="total-depositos">$4500.00</p>
        </div>
        <div class="bg-white p-4 rounded custom-shadow">
            <h2 class="text-lg font-semibold mb-2">Depósito más alto</h2>
            <p class="text-3xl font-bold text-green-500" id="deposito-mas-alto">$2000.00</p>
        </div>
        <div class="bg-white p-4 rounded custom-shadow">
            <h2 class="text-lg font-semibold mb-2">Promedio de Depósitos</h2>
            <p class="text-3xl font-bold text-purple-500" id="promedio-depositos">$1500.00</p>
        </div>
    </div>

    <div class="bg-white p-4 rounded custom-shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">Depósitos por Mes</h2>
        <canvas id="grafico-depositos" width="400" height="200"></canvas>
    </div>

    <div class="bg-white rounded custom-shadow overflow-x-auto">
        <table id="tabla-depositos" class="min-w-full">
            <thead>
                <tr class="bg-gray-100">
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Banco</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody id="depositos-body">
                <!-- Los depósitos se cargarán dinámicamente aquí -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para crear/editar depósito -->
<div id="deposito-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Crear Depósito</h3>
            <form id="deposito-form" class="mt-2 text-left">
                <input type="hidden" id="deposito-id">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="banco">
                        Banco
                    </label>
                    <select id="banco" name="banco" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Seleccione un banco</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="monto">
                        Monto
                    </label>
                    <input type="number" step="0.01" id="monto" name="monto" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="fecha">
                        Fecha
                    </label>
                    <input type="text" id="fecha" name="fecha" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="descripcion">
                        Descripción
                    </label>
                    <textarea id="descripcion" name="descripcion" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Guardar
                    </button>
                    <button type="button" id="cerrar-modal" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const crearDepositoBtn = document.getElementById('crear-deposito-btn');
    const depositoModal = document.getElementById('deposito-modal');
    const depositoForm = document.getElementById('deposito-form');
    const cerrarModalBtn = document.getElementById('cerrar-modal');
    const depositosBody = document.getElementById('depositos-body');
    const aplicarFiltrosBtn = document.getElementById('aplicar-filtros-btn');

    crearDepositoBtn.addEventListener('click', () => showModal('Crear Depósito'));
    cerrarModalBtn.addEventListener('click', hideModal);
    depositoForm.addEventListener('submit', handleSubmit);
    aplicarFiltrosBtn.addEventListener('click', loadDepositos);

    flatpickr("#fecha", {
        dateFormat: "Y-m-d",
    });

    flatpickr("#filtro-fecha", {
        dateFormat: "m/d/Y",
    });

    loadBancos();
    loadDepositos();
    initChart();

    function showModal(title) {
        document.getElementById('modal-title').textContent = title;
        depositoModal.classList.remove('hidden');
    }

    function hideModal() {
        depositoModal.classList.add('hidden');
        depositoForm.reset();
    }

    function loadBancos() {
        // Simulated API call
        const bancos = [
            { id: 1, nombre: 'Banco A' },
            { id: 2, nombre: 'Banco B' },
            { id: 3, nombre: 'Banco C' },
        ];
        const bancoSelect = document.getElementById('banco');
        bancos.forEach(banco => {
            const option = document.createElement('option');
            option.value = banco.id;
            option.textContent = banco.nombre;
            bancoSelect.appendChild(option);
        });
    }

    function loadDepositos() {
        // Simulated API call
        const depositos = [
            { id: 1, banco: 'Banco A', monto: 1000, fecha: '2023-04-30', descripcion: 'Depósito mensual' },
            { id: 2, banco: 'Banco B', monto: 1500, fecha: '2023-05-01', descripcion: 'Venta de activos' },
            { id: 3, banco: 'Banco C', monto: 2000, fecha: '2023-05-02', descripcion: 'Inversión' },
        ];
        updateTable(depositos);
        updateResumen(depositos);
    }

    function updateTable(depositos) {
        depositosBody.innerHTML = depositos.map(d => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">${d.banco}</td>
                <td class="px-6 py-4 whitespace-nowrap">$${d.monto.toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap">${d.fecha}</td>
                <td class="px-6 py-4 whitespace-nowrap">${d.descripcion}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="text-blue-600 hover:text-blue-900 mr-2" onclick="editarDeposito(${d.id})">Editar</button>
                    <button class="text-red-600 hover:text-red-900" onclick="eliminarDeposito(${d.id})">Eliminar</button>
                </td>
            </tr>
        `).join('');
    }

    function handleSubmit(e) {
        e.preventDefault();
        const formData = new FormData(depositoForm);
        const depositoData = Object.fromEntries(formData.entries());
        console.log('Datos del depósito:', depositoData);
        // Aquí iría la lógica para enviar los datos al servidor
        hideModal();
        loadDepositos(); // Recargar la lista de depósitos
    }

    function editarDeposito(id) {
        // Simular la carga de datos del depósito
        const deposito = { id: id, banco: 'Banco A', monto: 1000, fecha: '2023-05-01', descripcion: 'Editar este depósito' };
        document.getElementById('deposito-id').value = deposito.id;
        document.getElementById('banco').value = deposito.banco;
        document.getElementById('monto').value = deposito.monto;
        document.getElementById('fecha').value = deposito.fecha;
        document.getElementById('descripcion').value = deposito.descripcion;
        showModal('Editar Depósito');
    }

    function eliminarDeposito(id) {
        if (confirm('¿Está seguro de que desea eliminar este depósito?')) {
            console.log('Eliminando depósito:', id);
            // Aquí iría la lógica para eliminar el depósito del servidor
            loadDepositos(); // Recargar la lista de depósitos
        }
    }

    function updateResumen(depositos) {
        const total = depositos.reduce((sum, d) => sum + d.monto, 0);
        const maximo = Math.max(...depositos.map(d => d.monto));
        const promedio = total / depositos.length;

        document.getElementById('total-depositos').textContent = `$${total.toFixed(2)}`;
        document.getElementById('deposito-mas-alto').textContent = `$${maximo.toFixed(2)}`;
        document.getElementById('promedio-depositos').textContent = `$${promedio.toFixed(2)}`;
    }

    function initChart() {
        const ctx = document.getElementById('grafico-depositos').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo'],
                datasets: [{
                    label: 'Depósitos por Mes',
                    data: [3000, 3500, 4000, 4500, 5000],
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}