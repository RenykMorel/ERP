{% extends "base.html" %}
{% block title %}Gestión de Bancos - CalculAI{% endblock %}
{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    .modal {
        transition: opacity 0.25s ease;
    }
    body.modal-active {
        overflow-x: hidden;
        overflow-y: visible !important;
    }
    .green-border {
        border: 2px solid #4CAF50;
    }
    .green-border:focus {
        border-color: #45a049;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div id="bancos-module" class="container mx-auto px-4 py-6">
    <h1 class="text-2xl font-semibold mb-6 text-gray-800">Gestión de Bancos</h1>
    
    <div id="busqueda-form" class="bg-white shadow-sm rounded-lg px-6 py-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <input class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" type="text" id="id-banco" placeholder="ID">
            </div>
            <div>
                <input class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" type="text" id="nombre-banco" placeholder="Nombre">
            </div>
            <div>
                <input class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" type="text" id="contacto-banco" placeholder="Contacto">
            </div>
            <div>
                <select class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" id="estatus-banco">
                    <option value="">Todos</option>
                    <option value="activo">Activo</option>
                    <option value="inactivo">Inactivo</option>
                </select>
            </div>
        </div>
        <div class="flex justify-between mt-4">
            <button id="buscar-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-search mr-2"></i>Buscar
            </button>
            <button id="crear-nuevo-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fas fa-plus mr-2"></i>Crear Nuevo Banco
            </button>
            <button id="gestionar-cuentas-btn" class="px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                <i class="fas fa-university mr-2"></i>Gestionar Cuentas Bancarias
            </button>
        </div>
    </div>
    
    <div id="bancos-table-container" class="overflow-x-auto bg-white shadow-sm rounded-lg">
        <table id="bancos-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">ID</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Nombre</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Teléfono</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Contacto</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Teléfono Contacto</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Estatus</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody id="bancos-tbody" class="bg-white divide-y divide-gray-200">
                <!-- Bancos se cargarán aquí dinámicamente -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para Banco -->
<div id="banco-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    
    <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded shadow-lg z-50 overflow-y-auto green-border">
        <div class="modal-content py-4 text-left px-6">
            <div class="flex justify-between items-center pb-3">
                <p class="text-2xl font-bold text-gray-800" id="banco-modal-title">Crear Nuevo Banco</p>
                <div class="modal-close cursor-pointer z-50">
                    <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                        <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                    </svg>
                </div>
            </div>

            <form id="banco-form" class="mt-4 grid grid-cols-2 gap-4">
                <input type="hidden" name="id">
                <div class="col-span-2">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="nombre">
                        Nombre del Banco
                    </label>
                    <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="nombre" type="text" placeholder="Ingrese el nombre del banco" required>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="telefono">
                        Teléfono
                    </label>
                    <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="telefono" type="tel" placeholder="Ej: +1234567890" required>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="codigo">
                        Código
                    </label>
                    <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="codigo" type="text" placeholder="Código único del banco">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="contacto">
                        Nombre de Contacto
                    </label>
                    <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="contacto" type="text" placeholder="Nombre de la persona de contacto">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="telefono_contacto">
                        Teléfono de Contacto
                    </label>
                    <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="telefono_contacto" type="tel" placeholder="Ej: +1234567890">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="codigo_swift">
                        Código SWIFT
                    </label>
                    <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="codigo_swift" type="text" placeholder="Código SWIFT del banco">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="estatus">
                        Estatus
                    </label>
                    <select class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="estatus">
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="direccion">
                        Dirección
                    </label>
                    <textarea class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="direccion" rows="3" placeholder="Dirección completa del banco"></textarea>
                </div>
                <div class="col-span-2 flex items-center justify-end space-x-4 mt-4">
                    <button class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline modal-close" type="button">
                        Cancelar
                    </button>
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Cuentas Bancarias -->
<div id="cuentas-bancarias-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    
    <div class="modal-container bg-white w-11/12 md:max-w-4xl mx-auto rounded shadow-lg z-50 overflow-y-auto green-border">
        <div class="modal-content py-4 text-left px-6">
            <div class="flex justify-between items-center pb-3">
                <p class="text-2xl font-bold text-gray-800">Gestión de Cuentas Bancarias</p>
                <div class="modal-close cursor-pointer z-50">
                    <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                        <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                    </svg>
                </div>
            </div>

            <div class="mb-4">
                <button id="crear-cuenta-bancaria-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    <i class="fas fa-plus mr-2"></i>Crear Nueva Cuenta Bancaria
                </button>
            </div>

            <div id="cuentas-bancarias-table-container" class="overflow-x-auto">
                <table id="cuentas-bancarias-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Número</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Banco</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Tipo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Estatus</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cuentas-bancarias-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Cuentas bancarias se cargarán aquí dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear/Editar Cuenta Bancaria -->
<div id="cuenta-bancaria-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    
    <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded shadow-lg z-50 overflow-y-auto green-border">
        <div class="modal-content py-4 text-left px-6">
            <div class="flex justify-between items-center pb-3">
                <p class="text-2xl font-bold text-gray-800" id="cuenta-bancaria-modal-title">Crear Nueva Cuenta Bancaria</p>
                <div class="modal-close cursor-pointer z-50">
                    <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                        <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                    </svg>
                </div>
            </div>

            <form id="cuenta-bancaria-form" class="mt-4 grid grid-cols-2 gap-4">
                <input type="hidden" name="id">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="numero">
                        Número
                    </label>
                    <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="numero" type="text" required>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="nombre">
                        Nombre
                    </label>
                    <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="nombre" type="text" required>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="banco">
                        Banco
                    </label>
                    <select class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="banco" required>
                        <!-- Opciones de bancos se cargarán dinámicamente -->
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="divisa_id">
                        Divisa
                    </label>
                    <select id="divisa_id" name="divisa_id" class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Cargando divisas...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="tipo_cuenta">
                        Tipo de Cuenta
                    </label>
                    <select class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="tipo_cuenta" required>
                        <option value="Ahorro">Ahorro</option>
                        <option value="Corriente">Corriente</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="cuenta_contable">
                        Cuenta Contable
                    </label>
                    <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="cuenta_contable" type="text">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="codigo">
                        Código
                    </label>
                    <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="codigo" type="text">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="estatus">
                        Estatus
                    </label>
                    <select class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="estatus">
                        <option value="Activo">Activo</option>
                        <option value="Inactivo">Inactivo</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="form-checkbox" name="es_predeterminada">
                        <span class="ml-2">Es Predeterminada</span>
                    </label>
                </div>
                <div class="col-span-2">
                    <h3 class="text-lg font-semibold mb-2">Impresión de Cheque</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="dimensiones">
                                Dimensiones
                            </label>
                            <select class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="dimensiones">
                                <option value="1">Opción 1</option>
                                <option value="2">Opción 2</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="ajuste_vertical">
                                Ajuste Vertical
                            </label>
                            <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="ajuste_vertical" type="number">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="ajuste_horizontal">
                                Ajuste Horizontal
                            </label>
                            <input class="green-border shadow-sm appearance-none rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="ajuste_horizontal" type="number">
                        </div>
                    </div>
                </div>
                <div class="col-span-2 flex items-center justify-end space-x-4 mt-4">
                    <button class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline modal-close" type="button">
                        Cancelar
                    </button>
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initializeBancos();
        buscarBancos();
    });

    function initializeBancos() {
        // Obtener referencias a los elementos del DOM
        const buscarBtn = document.getElementById('buscar-btn');
        const crearNuevoBtn = document.getElementById('crear-nuevo-btn');
        const gestionarCuentasBtn = document.getElementById('gestionar-cuentas-btn');
        const bancoForm = document.getElementById('banco-form');
        const cuentaBancariaForm = document.getElementById('cuenta-bancaria-form');
        const crearCuentaBancariaBtn = document.getElementById('crear-cuenta-bancaria-btn');
        const modalOverlays = document.querySelectorAll('.modal-overlay');
        const modalCloseButtons = document.querySelectorAll('.modal-close');
    
        // Event listener para búsqueda de bancos
        buscarBtn.addEventListener('click', buscarBancos);
        crearNuevoBtn.addEventListener('click', () => {
            limpiarFormularioBanco();
            mostrarModal('banco-modal', 'Crear Nuevo Banco');
        });
        gestionarCuentasBtn.addEventListener('click', mostrarGestionCuentasBancarias);
    
        // Event listener para crear nuevo banco
        crearNuevoBtn.addEventListener('click', () => {
            limpiarFormularioBanco(); // Limpiar el formulario antes de mostrarlo
            mostrarModal('banco-modal', 'Crear Nuevo Banco');
        });
    
        // Event listener para gestionar cuentas bancarias
        gestionarCuentasBtn.addEventListener('click', mostrarGestionCuentasBancarias);
    
        // Event listener para guardar banco
        bancoForm.addEventListener('submit', (event) => {
            event.preventDefault();
            guardarBanco(event);
        });
    
        // Event listener para guardar cuenta bancaria
        cuentaBancariaForm.addEventListener('submit', (event) => {
            event.preventDefault();
            guardarCuentaBancaria(event);
        });
    
        // Event listener para crear nueva cuenta bancaria
        crearCuentaBancariaBtn.addEventListener('click', () => {
            crearNuevaCuentaBancaria();  // Usaremos una única función
        });
    
        // Event listeners para cerrar modales
        modalOverlays.forEach(overlay => {
            overlay.addEventListener('click', () => {
                cerrarModales();
                limpiarFormularioBanco(); // Limpiar formulario al cerrar
                limpiarFormularioCuentaBancaria(); // Limpiar formulario al cerrar
            });
        });
    
        modalCloseButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                cerrarModales();
                limpiarFormularioBanco(); // Limpiar formulario al cerrar
                limpiarFormularioCuentaBancaria(); // Limpiar formulario al cerrar
            });
        });
    
        // Event listeners para acciones en las tablas
        document.getElementById('bancos-tbody').addEventListener('click', manejarAccionesBanco);
        document.getElementById('cuentas-bancarias-tbody').addEventListener('click', manejarAccionesCuentaBancaria);
    
        // Cargar datos iniciales
        buscarBancos();
        
        // Inicializar selectores si es necesario
        cargarDivisas();
    }
    
    // Asegurarse de que la inicialización se ejecute cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        initializeBancos();
    });

    // Agregar esta función al principio de tu archivo JavaScript
    function mockObtenerCuentasBancarias() {
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve([
                    { id: 1, numero: '1234567890', nombre: 'Cuenta Principal', banco: 'Banco A', tipo_cuenta: 'Corriente', estatus: 'activo' },
                    { id: 2, numero: '0987654321', nombre: 'Cuenta Secundaria', banco: 'Banco B', tipo_cuenta: 'Ahorro', estatus: 'activo' },
                ]);
            }, 500);
        });
    }

    // Modificar la función cargarCuentasBancarias para usar la versión simulada
    function cargarCuentasBancarias() {
        fetch('/api/obtener-cuentas-bancarias')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(cuentas => {
                actualizarTablaCuentasBancarias(cuentas);
            })
            .catch(error => {
                console.error('Error al cargar cuentas bancarias:', error);
                Swal.fire('Error', `Ocurrió un error al cargar las cuentas bancarias: ${error.message}`, 'error');
            });
    }

    function limpiarFormularioCuentaBancaria() {
        const form = document.getElementById('cuenta-bancaria-form');
        form.reset();
        form.querySelector('input[name="id"]').value = '';
        form.querySelector('select[name="banco"]').innerHTML = '<option value="">Seleccione un banco</option>';
        form.querySelector('select[name="divisa_id"]').innerHTML = '<option value="">Seleccione una divisa</option>';
    }

    function obtenerBancos() {
        console.log('Obteniendo bancos...');
        return fetch('/api/obtener-bancos')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener los bancos');
                }
                return response.json();
            });
    }

    function obtenerDivisas() {
        console.log('Obteniendo divisas...');
        return fetch('/api/obtener-divisas')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener las divisas');
                }
                return response.json();
            });
    }
    

    function poblarSelectorBancos(bancos) {
        console.log('Poblando selector de bancos');
        const selector = document.querySelector('#cuenta-bancaria-form select[name="banco"]');
        selector.innerHTML = '<option value="">Seleccione un banco</option>';
        bancos.forEach(banco => {
            const option = document.createElement('option');
            option.value = banco.id;
            option.textContent = banco.nombre;
            selector.appendChild(option);
        });
    }

    function poblarSelectorMonedas(divisas) {
        console.log('Poblando selector de divisas');
        const selector = document.querySelector('#cuenta-bancaria-form select[name="divisa_id"]');
        selector.innerHTML = '<option value="">Seleccione una divisa</option>';
        divisas.forEach(divisa => {
            const option = document.createElement('option');
            option.value = divisa.id;
            option.textContent = `${divisa.nombre} (${divisa.simbolo || divisa.codigo})`;
            selector.appendChild(option);
        });
    }

    function mostrarModal(modalId, titulo) {
        const modal = document.getElementById(modalId);
        const tituloElement = modal.querySelector('.text-2xl');
        if (tituloElement && titulo) {
            tituloElement.textContent = titulo;
        }
        modal.classList.remove('opacity-0', 'pointer-events-none');
        document.body.classList.add('modal-active');
    
        // Si es el modal de cuenta bancaria, cargar los bancos y las divisas
        if (modalId === 'cuenta-bancaria-modal') {
            Promise.all([obtenerBancos(), obtenerDivisas()])
                .then(([bancos, divisas]) => {
                    poblarSelectorBancos(bancos);
                    poblarSelectorMonedas(divisas);
                })
                .catch(error => {
                    console.error('Error al cargar datos:', error);
                    Swal.fire('Error', 'No se pudieron cargar los datos necesarios', 'error');
                });
        }
    }

    function cerrarModales() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.classList.add('opacity-0', 'pointer-events-none');
        });
        document.body.classList.remove('modal-active');
    }

    function buscarBancos() {
        const id = document.getElementById('id-banco').value;
        const nombre = document.getElementById('nombre-banco').value;
        const contacto = document.getElementById('contacto-banco').value;
        const estatus = document.getElementById('estatus-banco').value;
    
        fetch(`/api/buscar-bancos?id=${id}&nombre=${nombre}&contacto=${contacto}&estatus=${estatus}`)
            .then(response => response.json())
            .then(bancos => {
                actualizarTablaBancos(bancos);
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al buscar bancos'
                });
            });
    }

    function actualizarTablaBancos(bancos) {
        const tbody = document.getElementById('bancos-tbody');
        tbody.innerHTML = '';
        bancos.forEach(banco => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${banco.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${banco.nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${banco.telefono}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${banco.contacto}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${banco.telefono_contacto}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${banco.estatus === 'activo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${banco.estatus.charAt(0).toUpperCase() + banco.estatus.slice(1)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button class="editar-banco text-blue-600 hover:text-blue-900 mr-2" data-id="${banco.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="eliminar-banco text-red-600 hover:text-red-900 mr-2" data-id="${banco.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="toggle-estatus-banco ${banco.estatus === 'activo' ? 'text-green-600 hover:text-green-900' : 'text-red-600 hover:text-red-900'}" data-id="${banco.id}" data-estatus="${banco.estatus}">
                        <i class="fas ${banco.estatus === 'activo' ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function guardarBanco(event) {
        event.preventDefault();
        
        // Mostrar indicador de carga
        Swal.fire({
            title: 'Procesando...',
            text: 'Guardando información del banco',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    
        const formData = new FormData(event.target);
        const bancoData = Object.fromEntries(formData);
        
        // Remover el id si está vacío o si estamos creando un nuevo banco
        const bancoId = bancoData.id || null;
        if (!bancoId) {
            delete bancoData.id;
        }
        
        const url = bancoId ? `/api/actualizar-banco/${bancoId}` : '/api/crear-banco';
        const method = bancoId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            body: JSON.stringify(bancoData),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json().then(data => {
                console.log('Response data:', data);
                return {
                    ok: response.ok,
                    status: response.status,
                    data: data
                };
            });
        })
        .then(({ ok, status, data }) => {
            // Si hay error en la respuesta
            if (!ok) {
                throw data;
            }
    
            // Si la operación fue exitosa
            cerrarModales();
            limpiarFormularioBanco();
            buscarBancos();
    
            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: bancoId ? 'Banco actualizado correctamente' : 'Banco creado correctamente',
                timer: 2000,
                showConfirmButton: false
            });
        })
        .catch(error => {
            console.error('Error:', error);
            
            let errorMessage = 'Ocurrió un error al procesar la solicitud';
            
            // Si el error tiene detalles específicos
            if (error.details) {
                errorMessage = Object.values(error.details).join('\n');
            } else if (error.error) {
                errorMessage = error.error;
            }
    
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: errorMessage,
                confirmButtonText: 'Entendido'
            });
        });
    }

    function manejarAccionesBanco(event) {
        const target = event.target.closest('button');
        if (!target) return;
    
        const id = target.dataset.id;
        if (target.classList.contains('editar-banco')) {
            editarBanco(id);
        } else if (target.classList.contains('eliminar-banco')) {
            eliminarBanco(id);
        } else if (target.classList.contains('toggle-estatus-banco')) {
            toggleEstatusBanco(id, target.dataset.estatus);
        }
    }

    function crearNuevaCuentaBancaria() {
        const form = document.getElementById('cuenta-bancaria-form');
        
        // Mostrar indicador de carga
        Swal.fire({
            title: 'Cargando...',
            text: 'Preparando formulario',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    
        // Cargar los datos necesarios
        Promise.all([obtenerBancos(), obtenerDivisas()])
            .then(([bancos, divisas]) => {
                // Limpiar el formulario
                form.reset();
                form.querySelector('input[name="id"]').value = '';
                
                // Poblar los selectores
                poblarSelectorBancos(bancos);
                poblarSelectorMonedas(divisas);
                
                // Cerrar el indicador de carga
                Swal.close();
                
                // Mostrar el modal
                mostrarModal('cuenta-bancaria-modal', 'Crear Nueva Cuenta Bancaria');
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudieron cargar los datos necesarios', 'error');
            });
    }

    function toggleEstatusBanco(id, estatusActual) {
        const nuevoEstatus = estatusActual === 'activo' ? 'inactivo' : 'activo';
        fetch(`/api/cambiar-estatus-banco/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ estatus: nuevoEstatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            Swal.fire('Éxito', `Estatus del banco cambiado a ${nuevoEstatus}`, 'success');
            buscarBancos();
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', error.message || 'Ocurrió un error al cambiar el estatus del banco', 'error');
        });
    }

    function editarBanco(id) {
        fetch(`/api/obtener-banco/${id}`)
            .then(response => response.json())
            .then(banco => {
                document.getElementById('banco-modal-title').textContent = 'Editar Banco';
                const form = document.getElementById('banco-form');
                for (const [key, value] of Object.entries(banco)) {
                    const field = form.elements[key];
                    if (field) {
                        field.value = value;
                    }
                }
                mostrarModal('banco-modal');
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo cargar la información del banco', 'error');
            });
    }

    function eliminarBanco(id) {
        Swal.fire({
            title: '¿Está seguro?',
            text: "Esta acción no se puede deshacer",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/eliminar-banco/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            Swal.fire('Eliminado', data.message, 'success');
                            buscarBancos();
                        } else {
                            Swal.fire('Error', data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Ocurrió un error al eliminar el banco', 'error');
                    });
            }
        });
    }

    function mostrarGestionCuentasBancarias() {
        mostrarModal('cuentas-bancarias-modal');
        cargarCuentasBancarias();
    }

    function cargarCuentasBancarias() {
        fetch('/api/obtener-cuentas-bancarias')
            .then(response => response.json())
            .then(cuentas => {
                actualizarTablaCuentasBancarias(cuentas);
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Ocurrió un error al cargar las cuentas bancarias', 'error');
            });
    }

    function actualizarTablaCuentasBancarias(cuentas) {
        const tbody = document.getElementById('cuentas-bancarias-tbody');
        tbody.innerHTML = '';
        cuentas.forEach(cuenta => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cuenta.numero}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${cuenta.nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cuenta.banco}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cuenta.tipo_cuenta}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cuenta.estatus}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button class="editar-cuenta-bancaria text-blue-600 hover:text-blue-900 mr-2" data-id="${cuenta.id}" onclick="editarCuentaBancaria(${cuenta.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="eliminar-cuenta-bancaria text-red-600 hover:text-red-900" data-id="${cuenta.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function cargarDivisas() {
        fetch('/api/obtener-divisas-activas')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                const selectDivisa = document.getElementById('divisa_id');
                selectDivisa.innerHTML = '<option value="">Seleccione una divisa</option>';
                data.forEach(divisa => {
                    const option = document.createElement('option');
                    option.value = divisa.id;
                    option.textContent = `${divisa.nombre} (${divisa.codigo})`;
                    selectDivisa.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar divisas:', error);
                alert('No se pudieron cargar las divisas. Por favor, intente nuevamente.');
            });
    }
    
    // Llamar a la función cuando se carga la página
    document.addEventListener('DOMContentLoaded', cargarDivisas);

    function guardarCuentaBancaria(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const cuentaData = Object.fromEntries(formData);
        
        // Remover el id si está vacío o si estamos creando una nueva cuenta
        const cuentaId = cuentaData.id || null;
        if (!cuentaId) {
            delete cuentaData.id;
        }
        
        // Convertir los ids a números
        cuentaData.banco_id = parseInt(cuentaData.banco, 10);
        cuentaData.divisa_id = parseInt(cuentaData.divisa_id, 10);
        
        const url = cuentaId ? `/api/actualizar-cuenta-bancaria/${cuentaId}` : '/api/crear-cuenta-bancaria';
        const method = cuentaId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            body: JSON.stringify(cuentaData),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) throw new Error(data.error);
            Swal.fire('Éxito', cuentaId ? 'Cuenta bancaria actualizada correctamente' : 'Cuenta bancaria creada correctamente', 'success');
            cerrarModales();
            cargarCuentasBancarias();
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', error.message || 'Ocurrió un error al guardar la cuenta bancaria', 'error');
        });
    }

    function limpiarFormularioBanco() {
        const form = document.getElementById('banco-form');
        form.reset();
        form.elements['id'].value = ''; // Limpiar el id oculto
    }
    
    function mostrarModal(modalId, titulo) {
        const modal = document.getElementById(modalId);
        const tituloElement = modal.querySelector('.text-2xl');
        if (tituloElement) {
            tituloElement.textContent = titulo;
        }
        modal.classList.remove('opacity-0', 'pointer-events-none');
        document.body.classList.add('modal-active');
    
        // Limpiar formularios según el modal
        if (modalId === 'banco-modal' && titulo === 'Crear Nuevo Banco') {
            limpiarFormularioBanco();
        } else if (modalId === 'cuenta-bancaria-modal' && titulo === 'Crear Nueva Cuenta Bancaria') {
            limpiarFormularioCuentaBancaria();
        }
    
        // Cargar datos necesarios para cuenta bancaria
        if (modalId === 'cuenta-bancaria-modal') {
            Promise.all([obtenerBancos(), obtenerDivisas()])
                .then(([bancos, divisas]) => {
                    poblarSelectorBancos(bancos);
                    poblarSelectorMonedas(divisas);
                })
                .catch(error => {
                    console.error('Error al cargar datos:', error);
                    Swal.fire('Error', 'No se pudieron cargar los datos necesarios', 'error');
                });
        }
    }    

    

    function manejarAccionesCuentaBancaria(event) {
        const target = event.target.closest('button');
        if (!target) return;

        const id = target.dataset.id;
        if (target.classList.contains('editar-cuenta-bancaria')) {
            editarCuentaBancaria(id);
        } else if (target.classList.contains('eliminar-cuenta-bancaria')) {
            eliminarCuentaBancaria(id);
        }
    }

    // Modificar la función editarCuentaBancaria para cargar los bancos y seleccionar el correcto
    function editarCuentaBancaria(id) {
        console.log('Iniciando edición de cuenta bancaria:', id);
        
        // Mostrar indicador de carga
        Swal.fire({
            title: 'Cargando...',
            text: 'Obteniendo información de la cuenta bancaria',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    
        // Primero, cargar los datos necesarios
        Promise.all([
            fetch(`/api/obtener-cuenta-bancaria/${id}`)
                .then(response => {
                    console.log('Respuesta de cuenta bancaria:', response.status);
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Cuenta bancaria no encontrada');
                        }
                        return response.json().then(err => {
                            throw new Error(err.error || 'Error al obtener la cuenta bancaria');
                        });
                    }
                    return response.json();
                }),
            obtenerBancos()
                .then(bancos => {
                    console.log('Bancos obtenidos:', bancos.length);
                    return bancos;
                }),
            obtenerDivisas()
                .then(divisas => {
                    console.log('Divisas obtenidas:', divisas.length);
                    return divisas;
                })
        ])
        .then(([cuenta, bancos, divisas]) => {
            console.log('Datos obtenidos:', { cuenta, bancos, divisas });
            
            // Cerrar el indicador de carga
            Swal.close();
    
            const form = document.getElementById('cuenta-bancaria-form');
            
            // Poblar los selectores
            poblarSelectorBancos(bancos);
            poblarSelectorMonedas(divisas);
            
            // Establecer los valores del formulario
            form.elements['id'].value = cuenta.id;
            form.elements['numero'].value = cuenta.numero;
            form.elements['nombre'].value = cuenta.nombre;
            form.elements['banco'].value = cuenta.banco_id;
            form.elements['divisa_id'].value = cuenta.divisa_id;
            form.elements['tipo_cuenta'].value = cuenta.tipo_cuenta;
            form.elements['estatus'].value = cuenta.estatus;
    
            // Mostrar el modal
            mostrarModal('cuenta-bancaria-modal', 'Editar Cuenta Bancaria');
        })
        .catch(error => {
            console.error('Error en editarCuentaBancaria:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'No se pudo cargar la información de la cuenta bancaria'
            });
        });
    }

    function eliminarCuentaBancaria(id) {
        Swal.fire({
            title: '¿Está seguro?',
            text: "Esta acción no se puede deshacer",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/eliminar-cuenta-bancaria/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            Swal.fire('Eliminada', data.message, 'success');
                            cargarCuentasBancarias();
                        } else {
                            Swal.fire('Error', data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Ocurrió un error al eliminar la cuenta bancaria', 'error');
                    });
            }
        });
    }
</script>
{% endblock %}