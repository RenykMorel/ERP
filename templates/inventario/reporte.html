{% extends "base.html" %}

{% block title %}Reporte de Inventario - CalculAI Inventario{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Reporte de Inventario</h1>

    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label for="fecha-inicio" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio</label>
                <input type="date" id="fecha-inicio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            </div>
            <div>
                <label for="fecha-fin" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                <input type="date" id="fecha-fin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            </div>
            <div>
                <label for="categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                <select id="categoria" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                    <option value="">Todas las categorías</option>
                    <!-- Las categorías se cargarán dinámicamente -->
                </select>
            </div>
        </div>

        <div class="flex justify-between items-center">
            <button id="generar-reporte-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 ease-in-out">
                <i class="fas fa-chart-bar mr-2"></i>Generar Reporte
            </button>
            <button id="exportar-excel-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 ease-in-out">
                <i class="fas fa-file-excel mr-2"></i>Exportar a Excel
            </button>
        </div>
    </div>

    <div id="reporte-container" class="bg-white shadow-md rounded-lg p-6">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Resumen</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-blue-100 p-4 rounded-lg">
                <h5 class="text-lg font-medium text-blue-800 mb-2">Total Items</h5>
                <p id="total-items" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-green-100 p-4 rounded-lg">
                <h5 class="text-lg font-medium text-green-800 mb-2">Valor Total del Inventario</h5>
                <p id="valor-total" class="text-3xl font-bold text-green-600">$0.00</p>
            </div>
            <div class="bg-yellow-100 p-4 rounded-lg">
                <h5 class="text-lg font-medium text-yellow-800 mb-2">Items con Stock Bajo</h5>
                <p id="items-stock-bajo" class="text-3xl font-bold text-yellow-600">0</p>
            </div>
        </div>

        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Detalle del Inventario</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Código
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Nombre
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Categoría
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Stock Inicial
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Entradas
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Salidas
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Stock Actual
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Valor Unitario
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Valor Total
                        </th>
                    </tr>
                </thead>
                <tbody id="reporte-tbody">
                    <!-- Los datos del reporte se cargarán aquí dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fechaInicio = document.getElementById('fecha-inicio');
    const fechaFin = document.getElementById('fecha-fin');
    const categoriaSelect = document.getElementById('categoria');
    const generarReporteBtn = document.getElementById('generar-reporte-btn');
    const exportarExcelBtn = document.getElementById('exportar-excel-btn');

    cargarCategorias();
    generarReporteBtn.addEventListener('click', generarReporte);
    exportarExcelBtn.addEventListener('click', exportarExcel);

    function cargarCategorias() {
        fetch('/inventario/api/categorias')
            .then(response => response.json())
            .then(data => {
                data.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.id;
                    option.textContent = categoria.nombre;
                    categoriaSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarNotificacion('Ocurrió un error al cargar las categorías', 'error');
            });
    }

    function generarReporte() {
        const params = new URLSearchParams({
            fecha_inicio: fechaInicio.value,
            fecha_fin: fechaFin.value,
            categoria: categoriaSelect.value
        });

        fetch(`/inventario/api/reporte?${params}`)
            .then(response => response.json())
            .then(data => {
                actualizarResumen(data.resumen);
                actualizarTablaReporte(data.detalle);
                mostrarNotificacion('Reporte generado con éxito', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarNotificacion('Ocurrió un error al generar el reporte', 'error');
            });
    }

    function actualizarResumen(resumen) {
        document.getElementById('total-items').textContent = resumen.total_items;
        document.getElementById('valor-total').textContent = `$${resumen.valor_total.toFixed(2)}`;
        document.getElementById('items-stock-bajo').textContent = resumen.items_stock_bajo;
    }

    function actualizarTablaReporte(detalle) {
        const tbody = document.getElementById('reporte-tbody');
        tbody.innerHTML = '';
        detalle.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">${item.codigo}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">${item.nombre}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">${item.categoria}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">${item.stock_inicial}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">${item.entradas}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">${item.salidas}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">${item.stock_actual}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">$${item.valor_unitario.toFixed(2)}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">$${item.valor_total.toFixed(2)}</p>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function exportarExcel() {
        const params = new URLSearchParams({
            fecha_inicio: fechaInicio.value,
            fecha_fin: fechaFin.value,
            categoria: categoriaSelect.value
        });

        window.location.href = `/inventario/api/exportar-excel?${params}`;
        mostrarNotificacion('Descarga de Excel iniciada', 'success');
    }

    function mostrarNotificacion(mensaje, tipo) {
        const notificacion = document.createElement('div');
        notificacion.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md text-white ${tipo === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        notificacion.textContent = mensaje;
        document.body.appendChild(notificacion);
        setTimeout(() => {
            notificacion.remove();
        }, 3000);
    }
});
</script>
{% endblock %}