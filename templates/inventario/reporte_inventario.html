{% extends "base.html" %}

{% block title %}Reporte de Inventario{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Reporte de Inventario</h1>

    <div class="row mb-3">
        <div class="col-md-4">
            <label for="fecha-inicio" class="form-label">Fecha de Inicio</label>
            <input type="date" class="form-control" id="fecha-inicio">
        </div>
        <div class="col-md-4">
            <label for="fecha-fin" class="form-label">Fecha de Fin</label>
            <input type="date" class="form-control" id="fecha-fin">
        </div>
        <div class="col-md-4">
            <label for="categoria" class="form-label">Categoría</label>
            <select class="form-control" id="categoria">
                <option value="">Todas las categorías</option>
                <!-- Las categorías se cargarán dinámicamente -->
            </select>
        </div>
    </div>

    <div class="mb-3">
        <button id="generar-reporte-btn" class="btn btn-primary">Generar Reporte</button>
        <button id="exportar-excel-btn" class="btn btn-success">Exportar a Excel</button>
    </div>

    <div id="reporte-container">
        <h2>Resumen</h2>
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total Items</h5>
                        <p class="card-text" id="total-items">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Valor Total del Inventario</h5>
                        <p class="card-text" id="valor-total">$0.00</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Items con Stock Bajo</h5>
                        <p class="card-text" id="items-stock-bajo">0</p>
                    </div>
                </div>
            </div>
        </div>

        <h2>Detalle del Inventario</h2>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Stock Inicial</th>
                        <th>Entradas</th>
                        <th>Salidas</th>
                        <th>Stock Actual</th>
                        <th>Valor Unitario</th>
                        <th>Valor Total</th>
                    </tr>
                </thead>
                <tbody id="reporte-tbody">
                    <!-- Los datos del reporte se cargarán aquí dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fechaInicio = document.getElementById('fecha-inicio');
    const fechaFin = document.getElementById('fecha-fin');
    const categoriaSelect = document.getElementById('categoria');
    const generarReporteBtn = document.getElementById('generar-reporte-btn');
    const exportarExcelBtn = document.getElementById('exportar-excel-btn');

    cargarCategorias();
    generarReporteBtn.addEventListener('click', generarReporte);
    exportarExcelBtn.addEventListener('click', exportarExcel);

    function cargarCategorias() {
        fetch('/inventario/api/categorias')
            .then(response => response.json())
            .then(data => {
                data.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.id;
                    option.textContent = categoria.nombre;
                    categoriaSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocurrió un error al cargar las categorías');
            });
    }

    function generarReporte() {
        const params = new URLSearchParams({
            fecha_inicio: fechaInicio.value,
            fecha_fin: fechaFin.value,
            categoria: categoriaSelect.value
        });

        fetch(`/inventario/api/reporte?${params}`)
            .then(response => response.json())
            .then(data => {
                actualizarResumen(data.resumen);
                actualizarTablaReporte(data.detalle);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocurrió un error al generar el reporte');
            });
    }

    function actualizarResumen(resumen) {
        document.getElementById('total-items').textContent = resumen.total_items;
        document.getElementById('valor-total').textContent = `$${resumen.valor_total.toFixed(2)}`;
        document.getElementById('items-stock-bajo').textContent = resumen.items_stock_bajo;
    }

    function actualizarTablaReporte(detalle) {
        const tbody = document.getElementById('reporte-tbody');
        tbody.innerHTML = '';
        detalle.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.codigo}</td>
                <td>${item.nombre}</td>
                <td>${item.categoria}</td>
                <td>${item.stock_inicial}</td>
                <td>${item.entradas}</td>
                <td>${item.salidas}</td>
                <td>${item.stock_actual}</td>
                <td>$${item.valor_unitario.toFixed(2)}</td>
                <td>$${item.valor_total.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function exportarExcel() {
        const params = new URLSearchParams({
            fecha_inicio: fechaInicio.value,
            fecha_fin: fechaFin.value,
            categoria: categoriaSelect.value
        });

        window.location.href = `/inventario/api/exportar-excel?${params}`;
    }
});
</script>
{% endblock %}