{% extends "base.html" %}

{% block title %}Gestión de Inventario - CalculAI{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    .required-field::after {
        content: " *";
        color: #ef4444;
    }
    .green-border {
        border: 2px solid #10B981;
    }
    #itemModal .green-border {
        border-color: #10B981;
    }
    #itemModal input, #itemModal select, #itemModal textarea {
        border: 2px solid #10B981;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Gestión de Inventario</h1>

    <div class="mb-6">
        <button id="crear-item-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
            <i class="fas fa-plus mr-2"></i>Crear Nuevo Item
        </button>
    </div>

    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full leading-normal">
            <thead>
                <tr>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Código
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Nombre
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Tipo
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Categoría
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Precio con Impuesto
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Stock Actual
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Acciones
                    </th>
                </tr>
            </thead>
            <tbody id="items-tbody">
                <!-- Los items se cargarán aquí dinámicamente -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para crear/editar item -->
<div id="itemModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full green-border">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modal-title">
                    Crear/Editar Item
                </h3>
                <p class="text-sm text-gray-500 mb-4">Los campos marcados con <span class="text-red-500">*</span> son obligatorios.</p>
                <form id="item-form" class="space-y-6">
                    <input type="hidden" id="item-id" name="id">
                    
                    <!-- Campos obligatorios -->
                    <div class="space-y-4">
                        <div>
                            <label for="item-nombre" class="block text-sm font-medium text-gray-700 mb-1 required-field">Nombre del Item</label>
                            <input type="text" id="item-nombre" name="nombre" required class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>

                        <div>
                            <label for="item-tipo" class="block text-sm font-medium text-gray-700 mb-1 required-field">Tipo de Item</label>
                            <select id="item-tipo" name="tipo" required class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="producto">Producto</option>
                                <option value="servicio">Servicio</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>

                        <div id="nuevo-tipo-container" class="hidden">
                            <label for="item-nuevo-tipo" class="block text-sm font-medium text-gray-700 mb-1">Nuevo Tipo de Item</label>
                            <input type="text" id="item-nuevo-tipo" name="nuevo_tipo" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>

                        <div>
                            <label for="item-costo" class="block text-sm font-medium text-gray-700 mb-1 required-field">Costo</label>
                            <input type="number" id="item-costo" name="costo" required step="0.01" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>

                        <div>
                            <label for="item-itbis" class="block text-sm font-medium text-gray-700 mb-1 required-field">ITBIS (%)</label>
                            <input type="number" id="item-itbis" name="itbis" required step="0.01" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>

                        <div>
                            <label for="item-margen" class="block text-sm font-medium text-gray-700 mb-1 required-field">Margen de Ganancia (%)</label>
                            <input type="number" id="item-margen" name="margen" required step="0.01" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>

                        <div>
                            <label for="item-precio-final" class="block text-sm font-medium text-gray-700 mb-1">Precio Final</label>
                            <input type="number" id="item-precio-final" name="precio_final" step="0.01" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <p class="mt-1 text-sm text-gray-500">Observación: El precio final está basado en el margen de ganancia.</p>
                        </div>
                    </div>

                    <!-- Secciones colapsables para información adicional -->
                    <div class="space-y-4">
                        <div x-data="{ open: false }">
                            <button @click="open = !open" type="button" class="flex justify-between w-full px-4 py-2 text-sm font-medium text-left text-blue-500 bg-blue-100 rounded-lg hover:bg-blue-200 focus:outline-none focus-visible:ring focus-visible:ring-blue-500 focus-visible:ring-opacity-50">
                                <span>Información Adicional</span>
                                <svg :class="{'transform rotate-180': open}" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div x-show="open" class="mt-2 space-y-4">
                                <div>
                                    <label for="item-descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                                    <textarea id="item-descripcion" name="descripcion" rows="3" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                                </div>
                                <div>
                                    <label for="item-categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                                    <input type="text" id="item-categoria" name="categoria" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="item-proveedor" class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                                    <input type="text" id="item-proveedor" name="proveedor" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="item-marca" class="block text-sm font-medium text-gray-700 mb-1">Marca/Modelo</label>
                                    <input type="text" id="item-marca" name="marca" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="item-unidad-medida" class="block text-sm font-medium text-gray-700 mb-1">Unidad de Medida</label>
                                    <input type="text" id="item-unidad-medida" name="unidad_medida" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="item-stock-inicial" class="block text-sm font-medium text-gray-700 mb-1">Stock Inicial</label>
                                    <input type="number" id="item-stock-inicial" name="stock_inicial" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="item-stock-minimo" class="block text-sm font-medium text-gray-700 mb-1">Stock Mínimo</label>
                                    <input type="number" id="item-stock-minimo" name="stock_minimo" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="item-stock-maximo" class="block text-sm font-medium text-gray-700 mb-1">Stock Máximo</label>
                                    <input type="number" id="item-stock-maximo" name="stock_maximo" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="item-almacen" class="block text-sm font-medium text-gray-700 mb-1">Almacén</label>
                                    <select id="item-almacen" name="almacen" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Seleccione un almacén</option>
                                        <!-- Opciones de almacén se cargarán dinámicamente -->
                                    </select>
                                </div>
                                <div>
                                    <label for="item-cuenta-ingresos" class="block text-sm font-medium text-gray-700 mb-1">Cuenta de Ingresos</label>
                                    <select id="item-cuenta-ingresos" name="cuenta_ingresos" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500  focus:border-blue-500 sm:text-sm">
                                        <option  value="">Seleccione una cuenta</option>
                                        <!-- Opciones de cuentas se cargarán  dinámicamente -->
                                    </select>
                                </div>
                                <div>
                                    <label for="item-cuenta-gastos" class="block text-sm font-medium text-gray-700 mb-1">Cuenta de Gastos</label>
                                    <select id="item-cuenta-gastos" name="cuenta_gastos" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Seleccione una cuenta</option>
                                        <!-- Opciones de cuentas se cargarán dinámicamente -->
                                    </select>
                                </div>
                                <div>
                                    <label for="item-centro-costo" class="block text-sm font-medium text-gray-700 mb-1">Centro de Costo</label>
                                    <select id="item-centro-costo" name="centro_costo" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Seleccione un centro de costo</option>
                                        <!-- Opciones de centros de costo se cargarán dinámicamente -->
                                    </select>
                                </div>
                                <div>
                                    <label for="item-imagen" class="block text-sm font-medium text-gray-700 mb-1">Imagen del Producto</label>
                                    <input type="file" id="item-imagen" name="imagen" accept="image/*" class="mt-1 block w-full green-border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm" id="guardar-item-btn">
                    Guardar
                </button>
                <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" id="cerrar-modal-btn">
                    Cancelar
                </button>
                <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" id="eliminar-item-btn">
                    Eliminar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const crearItemBtn = document.getElementById('crear-item-btn');
    const guardarItemBtn = document.getElementById('guardar-item-btn');
    const cerrarModalBtn = document.getElementById('cerrar-modal-btn');
    const eliminarItemBtn = document.getElementById('eliminar-item-btn');
    const itemModal = document.getElementById('itemModal');
    const itemForm = document.getElementById('item-form');
    const itemTipo = document.getElementById('item-tipo');
    const nuevoTipoContainer = document.getElementById('nuevo-tipo-container');
    const costoInput = document.getElementById('item-costo');
    const itbisInput = document.getElementById('item-itbis');
    const margenInput = document.getElementById('item-margen');
    const precioFinalInput = document.getElementById('item-precio-final');

    crearItemBtn.addEventListener('click', () => mostrarModalItem());
    guardarItemBtn.addEventListener('click', guardarItem);
    cerrarModalBtn.addEventListener('click', () => itemModal.classList.add('hidden'));
    eliminarItemBtn.addEventListener('click', () => eliminarItem(itemForm.id.value));
    itemTipo.addEventListener('change', toggleNuevoTipo);
    precioFinalInput.addEventListener('input', actualizarMargen);

    costoInput.addEventListener('input', calcularPrecioFinal);
    itbisInput.addEventListener('input', calcularPrecioFinal);
    margenInput.addEventListener('input', calcularPrecioFinal);

    cargarItems();
    cargarOpciones();

    function mostrarModalItem(id = null) {
        itemForm.reset();
        if (id) {
            cargarDatosItem(id);
        } else {
            document.getElementById('modal-title').textContent = 'Crear Nuevo Item';
            eliminarItemBtn.classList.add('hidden');
        }
        toggleNuevoTipo();
        itemModal.classList.remove('hidden');
    }

    function toggleNuevoTipo() {
        if (itemTipo.value === 'otro') {
            nuevoTipoContainer.classList.remove('hidden');
        } else {
            nuevoTipoContainer.classList.add('hidden');
        }
    }

    function calcularPrecioFinal() {
        const costo = parseFloat(costoInput.value) || 0;
        const itbis = parseFloat(itbisInput.value) || 0;
        const margen = parseFloat(margenInput.value) || 0;

        const costoConItbis = costo * (1 + itbis / 100);
        const precioFinal = costoConItbis / (1 - margen / 100);

        precioFinalInput.value = precioFinal.toFixed(2);
    }

    function actualizarMargen() {
        const costo = parseFloat(costoInput.value) || 0;
        const itbis = parseFloat(itbisInput.value) || 0;
        const precioFinal = parseFloat(precioFinalInput.value) || 0;

        const costoConItbis = costo * (1 + itbis / 100);
        const nuevoMargen = ((precioFinal - costoConItbis) / precioFinal) * 100;

        margenInput.value = nuevoMargen.toFixed(2);
    }

    function cargarItems() {
        fetch('/api/items')
            .then(response => response.json())
            .then(items => {
                const tbody = document.getElementById('items-tbody');
                tbody.innerHTML = '';
                items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${item.codigo}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${item.nombre}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${item.tipo}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${item.categoria || '-'}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${item.precio_con_impuesto} ${item.moneda}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${item.stock_inicial || '-'}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <button class="text-blue-600 hover:text-blue-900 editar-item" data-id="${item.id}">Editar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.querySelectorAll('.editar-item').forEach(btn => {
                    btn.addEventListener('click', (e) => mostrarModalItem(e.target.dataset.id));
                });
            })
            .catch(error => console.error('Error:', error));
    }

    function cargarDatosItem(id) {
        fetch(`/api/items/${id}`)
            .then(response => response.json())
            .then(item => {
                document.getElementById('modal-title').textContent = 'Editar Item';
                eliminarItemBtn.classList.remove('hidden');
                for (const [key, value] of Object.entries(item)) {
                    const field = document.getElementById(`item-${key}`);
                    if (field) {
                        field.value = value;
                    }
                }
                toggleNuevoTipo();
            })
            .catch(error => console.error('Error:', error));
    }

    function guardarItem() {
        const formData = new FormData(itemForm);
        const itemData = Object.fromEntries(formData.entries());
        const method = itemData.id ? 'PUT' : 'POST';
        const url = itemData.id ? `/api/items/${itemData.id}` : '/api/items';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(itemData),
        })
        .then(response => response.json())
        .then(data => {
            itemModal.classList.add('hidden');
            cargarItems();
        })
        .catch(error => console.error('Error:', error));
    }

    function eliminarItem(id) {
        if (confirm('¿Está seguro de que desea eliminar este item?')) {
            fetch(`/api/items/${id}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (response.ok) {
                    itemModal.classList.add('hidden');
                    cargarItems();
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }

    function cargarOpciones() {
        // Aquí se cargarían las opciones para los selects (almacenes, cuentas, etc.)
        // Por ejemplo:
        fetch('/api/almacenes')
            .then(response => response.json())
            .then(almacenes => {
                const select = document.getElementById('item-almacen');
                almacenes.forEach(almacen => {
                    const option = document.createElement('option');
                    option.value = almacen.id;
                    option.textContent = almacen.nombre;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error('Error:', error));

        // Repite este proceso para otros selects como cuentas, centros de costo, etc.
    }
});
</script>
{% endblock %}