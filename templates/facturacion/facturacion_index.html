{% extends "base.html" %}
{% block title %}Gestión de Facturas - CalculAI{% endblock %}
{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    .modal {
        transition: opacity 0.25s ease;
    }
    body.modal-active {
        overflow-x: hidden;
        overflow-y: visible !important;
    }
    .compact-form label {
        font-size: 0.75rem;
    }
    .compact-form input, .compact-form select, .compact-form textarea {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
    }
    .compact-table th, .compact-table td {
        padding: 0.5rem;
        font-size: 0.75rem;
    }
    @media (max-width: 640px) {
        .compact-table th, .compact-table td {
            padding: 0.25rem;
            font-size: 0.7rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="facturas-module" class="container mx-auto px-4 py-6">
    <h1 class="text-2xl font-semibold mb-6 text-gray-800">Gestión de Facturas</h1>
    
    <div id="busqueda-form" class="bg-white shadow-sm rounded-lg px-6 py-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <input class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" type="text" id="numero-factura" placeholder="Número de factura">
            </div>
            <div>
                <input class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" type="text" id="cliente-factura" placeholder="Cliente">
            </div>
            <div>
                <input class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" type="date" id="fecha-factura">
            </div>
            <div>
                <select class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" id="estatus-factura">
                    <option value="">Todos los estados</option>
                    <option value="facturada">Facturada</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="cancelada">Cancelada</option>
                </select>
            </div>
        </div>
        <div class="flex justify-between mt-4">
            <button id="buscar-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-search mr-2"></i>Buscar
            </button>
            <button id="crear-nuevo-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fas fa-plus mr-2"></i>Crear Nueva Factura
            </button>
        </div>
    </div>
    
    <div id="facturas-table-container" class="overflow-x-auto bg-white shadow-sm rounded-lg">
        <table id="facturas-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">ID</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Cliente</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Fecha</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Total</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Tipo</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Estatus</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody id="facturas-tbody" class="bg-white divide-y divide-gray-200">
                <!-- Las facturas se cargarán aquí dinámicamente -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para crear/editar factura -->
<div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    
    <div class="modal-container bg-white w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 mx-auto rounded shadow-lg z-50 overflow-y-auto" style="max-width: 800px; max-height: 800px;">
        <div class="modal-content py-4 text-left px-6">
            <div class="flex justify-between items-center pb-3">
                <p class="text-xl font-bold" id="modal-title">Crear Nueva Factura</p>
                <div class="modal-close cursor-pointer z-50">
                    <i class="fas fa-times"></i>
                </div>
            </div>

            <form id="factura-form" class="mt-4 compact-form">
                <div class="grid grid-cols-2 gap-4">
                    <input type="hidden" name="id">
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="fecha">Fecha</label>
                        <input class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="fecha" type="datetime-local" readonly>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="tipo_venta">Tipo de Venta</label>
                        <div class="mt-1">
                            <label class="inline-flex items-center">
                                <input type="radio" class="form-radio" name="tipo_venta" value="contado" checked>
                                <span class="ml-2 text-sm">Contado</span>
                            </label>
                            <label class="inline-flex items-center ml-4">
                                <input type="radio" class="form-radio" name="tipo_venta" value="credito">
                                <span class="ml-2 text-sm">Crédito</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="cliente">Cliente</label>
                        <div class="relative">
                            <input class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline pr-8" name="cliente" type="text" placeholder="Buscar cliente...">
                            <button type="button" class="absolute inset-y-0 right-0 px-2 flex items-center bg-gray-100 rounded-r border-l">
                                <i class="fas fa-search text-gray-600"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="condicion">Condición</label>
                        <select class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="condicion">
                            <option value="contado">Contado</option>
                            <option value="credito_30">Crédito 30 días</option>
                            <option value="credito_60">Crédito 60 días</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="documento">Documento / Nombre Completo</label>
                        <input class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="documento" type="text" placeholder="Número de identificación / Nombre">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="direccion">Dirección</label>
                        <textarea class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="direccion" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="tienda">Tienda</label>
                        <select class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="tienda">
                            <option value="sucursal1">Sucursal 1</option>
                            <option value="sucursal2">Sucursal 2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="vendedor">Vendedor</label>
                        <select class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="vendedor">
                            <option value="vendedor1">Vendedor 1</option>
                            <option value="vendedor2">Vendedor 2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="descuento">Descuento</label>
                        <div class="flex">
                            <input class="shadow-sm appearance-none border rounded-l w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="descuento" type="number" step="0.01" min="0">
                            <select class="shadow-sm appearance-none border-t border-b border-r rounded-r bg-gray-100 text-gray-700 py-1 px-2 leading-tight focus:outline-none focus:shadow-outline" name="tipo_descuento">
                                <option value="porcentaje">%</option>
                                <option value="monto">$</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="estatus">Estatus</label>
                        <select class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="estatus">
                            <option value="facturada">Facturada</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="moneda">Moneda</label>
                        <select class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="moneda">
                            <option value="dop">DOP</option>
                            <option value="usd">USD</option>
                            <option value="eur">EUR</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="notas">Notas</label>
                        <textarea class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="notas" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1" for="ncf">NCF</label>
                        <input class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="ncf" type="text" placeholder="Número de Comprobante Fiscal">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold  mb-1" for="documento_relacionado">Documento Relacionado</label>
                        <select class="shadow-sm appearance-none border rounded w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" name="documento_relacionado">
                            <option value="">Seleccionar...</option>
                            <option value="pre_factura">Pre-Factura</option>
                            <option value="cotizacion">Cotización</option>
                            <option value="proyecto">Proyecto</option>
                            <option value="orden_venta">Orden de Venta</option>
                        </select>
                    </div>
                </div>

                <div class="mt-4">
                    <h3 class="text-sm font-semibold mb-2">Productos y Servicios</h3>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <div class="flex space-x-2 mb-2">
                            <button type="button" id="agregar-producto" class="bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">
                                Agregar Producto
                            </button>
                            <button type="button" id="agregar-nota-credito" class="bg-green-500 hover:bg-green-700 text-white text-xs font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">
                                Nota de Crédito / Anticipo
                            </button>
                            <button type="button" id="cargar-excel" class="bg-yellow-500 hover:bg-yellow-700 text-white text-xs font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">
                                Cargar Excel
                            </button>
                        </div>
                        <table class="min-w-full divide-y divide-gray-200 compact-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ITBIS</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="items-factura" class="bg-white divide-y divide-gray-200">
                                <!-- Los items se agregarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-4 flex flex-wrap justify-between">
                    <div class="space-x-2">
                        <button type="submit" class="bg-green-500 hover:bg-green-700 text-white text-xs font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Grabar
                        </button>
                        <button type="button" id="limpiar-form" class="bg-yellow-500 hover:bg-yellow-700 text-white text-xs font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Limpiar
                        </button>
                        <button type="button" class="modal-close bg-gray-500 hover:bg-gray-700 text-white text-xs font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Volver
                        </button>
                    </div>
                    <div class="space-x-2 mt-2 sm:mt-0">
                        <button type="button" id="clonar-factura" class="bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Clonar
                        </button>
                        <button type="button" id="cancelar-factura" class="bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Cancelar
                        </button>
                        <button type="button" id="generar-reporte" class="bg-purple-500 hover:bg-purple-700 text-white text-xs font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Reporte
                        </button>
                        <button type="button" id="enviar-email" class="bg-indigo-500 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            E-mail
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para crear/editar item -->
<div id="itemModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modal-title">
                    Crear/Editar Item
                </h3>
                <form id="item-form" class="space-y-6">
                    <input type="hidden" id="item-id" name="id">
                    
                    <!-- Información Básica del Ítem -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-md font-medium text-gray-700 mb-3">Información Básica</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="item-tipo" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Ítem</label>
                                <select id="item-tipo" name="tipo" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Seleccione un tipo</option>
                                    <option value="producto">Producto</option>
                                    <option value="servicio">Servicio</option>
                                </select>
                            </div>
                            <div>
                                <label for="item-codigo" class="block text-sm font-medium text-gray-700 mb-1">Código o SKU</label>
                                <input type="text" id="item-codigo" name="codigo" required class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="item-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Ítem</label>
                                <input type="text" id="item-nombre" name="nombre" required class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="item-descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                                <textarea id="item-descripcion" name="descripcion" rows="3" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Precios y Fiscalidad -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-md font-medium text-gray-700 mb-3">Precios y Fiscalidad</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="item-precio-con-impuesto" class="block text-sm font-medium text-gray-700 mb-1">Precio con Impuesto</label>
                                <input type="number" step="0.01" id="item-precio-con-impuesto" name="precio_con_impuesto" required class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="item-precio-sin-impuesto" class="block text-sm font-medium text-gray-700 mb-1">Precio sin Impuesto</label>
                                <input type="number" step="0.01" id="item-precio-sin-impuesto" name="precio_sin_impuesto" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="item-tasa-impuesto" class="block text-sm font-medium text-gray-700 mb-1">Tasa de Impuesto</label>
                                <select id="item-tasa-impuesto" name="tasa_impuesto" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Seleccione una tasa</option>
                                    <option value="18">ITBIS 18%</option>
                                    <option value="16">16%</option>
                                    <option value="0">Exento</option>
                                </select>
                            </div>
                            <div>
                                <label for="item-moneda" class="block text-sm font-medium text-gray-700 mb-1">Moneda</label>
                                <select id="item-moneda" name="moneda" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="DOP">DOP</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Inventario (para productos) -->
                    <div id="inventario-section" class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-md font-medium text-gray-700 mb-3">Inventario</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="item-stock-inicial" class="block text-sm font-medium text-gray-700 mb-1">Stock Inicial</label>
                                <input type="number" id="item-stock-inicial" name="stock_inicial" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="item-stock-minimo" class="block text-sm font-medium text-gray-700 mb-1">Stock Mínimo</label>
                                <input type="number" id="item-stock-minimo" name="stock_minimo" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm" id="guardar-item-btn">
                    Guardar
                </button>
                <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" id="cerrar-modal-btn">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let lastFacturaId = 0;
    let lastItemId = 0;

    const buscarBtn = document.getElementById('buscar-btn');
    const crearNuevoBtn = document.getElementById('crear-nuevo-btn');
    const facturaForm = document.getElementById('factura-form');
    const modal = document.querySelector('.modal');
    const modalCloseButtons = document.querySelectorAll('.modal-close');
    const tipo_venta = document.querySelectorAll('input[name="tipo_venta"]');
    const agregarProductoBtn = document.getElementById('agregar-producto');
    const limpiarFormBtn = document.getElementById('limpiar-form');
    const clonarFacturaBtn = document.getElementById('clonar-factura');
    const cancelarFacturaBtn = document.getElementById('cancelar-factura');
    const generarReporteBtn = document.getElementById('generar-reporte');
    const enviarEmailBtn = document.getElementById('enviar-email');
    const itemModal = document.getElementById('itemModal');
    const itemForm = document.getElementById('item-form');
    const guardarItemBtn = document.getElementById('guardar-item-btn');
    const cerrarModalBtn = document.getElementById('cerrar-modal-btn');
    const itemTipo = document.getElementById('item-tipo');

    buscarBtn.addEventListener('click', buscarFacturas);
    crearNuevoBtn.addEventListener('click', mostrarFormularioCrearFactura);
    facturaForm.addEventListener('submit', guardarFactura);
    modalCloseButtons.forEach(btn => btn.addEventListener('click', toggleModal));
    tipo_venta.forEach(radio => radio.addEventListener('change', toggleCamposCredito));
    agregarProductoBtn.addEventListener('click', mostrarFormularioCrearItem);
    limpiarFormBtn.addEventListener('click', limpiarFormulario);
    clonarFacturaBtn.addEventListener('click', clonarFactura);
    cancelarFacturaBtn.addEventListener('click', cancelarFactura);
    generarReporteBtn.addEventListener('click', generarReporte);
    enviarEmailBtn.addEventListener('click', enviarEmail);
    guardarItemBtn.addEventListener('click', guardarItem);
    cerrarModalBtn.addEventListener('click', cerrarModalItem);
    itemTipo.addEventListener('change', toggleInventarioSection);

    document.getElementById('facturas-tbody').addEventListener('click', manejarAccionesFactura);

    function buscarFacturas() {
        // Implementación de búsqueda (simulada por ahora)
        const facturas = [
            { id: 1, cliente: 'Cliente A', fecha: '2023-05-01 10:30', total: 1000, tipo: 'Contado', estatus: 'Facturada' },
            { id: 2, cliente: 'Cliente B', fecha: '2023-05-02 14:45', total: 1500, tipo: 'Crédito', estatus: 'Pendiente' },
            { id: 3, cliente: 'Cliente C', fecha: '2023-05-03 09:15', total: 2000, tipo: 'Contado', estatus: 'Cancelada' },
        ];
        mostrarFacturas(facturas);
    }

    function mostrarFacturas(facturas) {
        const tbody = document.getElementById('facturas-tbody');
        tbody.innerHTML = '';
        facturas.forEach(factura => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">${factura.id}</td>
                <td class="px-6 py-4 whitespace-nowrap">${factura.cliente}</td>
                <td class="px-6 py-4 whitespace-nowrap">${factura.fecha}</td>
                <td class="px-6 py-4 whitespace-nowrap">${factura.total.toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap">${factura.tipo}</td>
                <td class="px-6 py-4 whitespace-nowrap">${factura.estatus}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="text-blue-600 hover:text-blue-900 mr-2 editar-factura" data-id="${factura.id}">Editar</button>
                    <button class="text-red-600 hover:text-red-900 eliminar-factura" data-id="${factura.id}">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        lastFacturaId = Math.max(...facturas.map(f => f.id), 0);
    }

    function mostrarFormularioCrearFactura() {
        document.getElementById('modal-title').textContent = 'Crear Nueva Factura';
        document.getElementById('factura-form').reset();
        const fechaActual = new Date().toISOString().slice(0, 16);
        document.querySelector('input[name="fecha"]').value = fechaActual;
        document.querySelector('input[name="id"]').value = lastFacturaId + 1;
        toggleModal();
        limpiarItemsFactura();
    }

    function guardarFactura(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        // Aquí iría la lógica para guardar la factura en el backend
        console.log('Factura guardada:', Object.fromEntries(formData));

        Swal.fire({
            title: 'Éxito',
            text: 'La factura ha sido guardada correctamente',
            icon: 'success',
            confirmButtonText: 'Ok'
        }).then(() => {
            toggleModal();
            buscarFacturas();
        });
    }

    function manejarAccionesFactura(event) {
        if (event.target.classList.contains('editar-factura')) {
            const facturaId = event.target.getAttribute('data-id');
            editarFactura(facturaId);
        } else if (event.target.classList.contains('eliminar-factura')) {
            const facturaId = event.target.getAttribute('data-id');
            eliminarFactura(facturaId);
        }
    }

    function editarFactura(facturaId) {
        // Aquí iría la lógica para obtener los datos de la factura del backend
        const factura = {
            id: facturaId,
            cliente: 'Cliente Ejemplo',
            fecha: '2023-05-01T10:30',
            total: 1000,
            tipo: 'contado',
            estatus: 'facturada'
        };

        document.getElementById('modal-title').textContent = 'Editar Factura';
        const form = document.getElementById('factura-form');
        form.elements['id'].value = factura.id;
        form.elements['cliente'].value = factura.cliente;
        form.elements['fecha'].value = factura.fecha;
        form.elements['tipo_venta'].value = factura.tipo;
        form.elements['estatus'].value = factura.estatus;

        toggleModal();
    }

    function eliminarFactura(facturaId) {
        Swal.fire({
            title: '¿Estás seguro?',
            text: "No podrás revertir esta acción",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                // Aquí iría la lógica para eliminar la factura en el backend
                console.log('Factura eliminada:', facturaId);

                Swal.fire(
                    'Eliminada',
                    'La factura ha sido eliminada.',
                    'success'
                ).then(() => {
                    buscarFacturas();
                });
            }
        });
    }

    function toggleModal() {
        modal.classList.toggle('opacity-0');
        modal.classList.toggle('pointer-events-none');
        document.body.classList.toggle('modal-active');
    }

    function toggleCamposCredito() {
        const tipoVenta = document.querySelector('input[name="tipo_venta"]:checked').value;
        const condicionSelect = document.querySelector('select[name="condicion"]');
        if (tipoVenta === 'credito') {
            condicionSelect.disabled = false;
        } else {
            condicionSelect.disabled = true;
            condicionSelect.value = 'contado';
        }
    }

    function mostrarFormularioCrearItem() {
        itemForm.reset();
        document.getElementById('item-id').value = '';
        itemModal.classList.remove('hidden');
    }

    function guardarItem() {
        const formData = new FormData(itemForm);
        const itemData = Object.fromEntries(formData);
        
        // Aquí iría la lógica para guardar el item en el backend
        console.log('Item guardado:', itemData);

        // Agregar el item a la tabla de items de la factura
        agregarItemATabla(itemData);

        cerrarModalItem();
    }

    function agregarItemATabla(item) {
        const itemsFactura = document.getElementById('items-factura');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">${item.nombre}</td>
            <td class="px-6 py-4 whitespace-nowrap">${item.stock_inicial || 1}</td>
            <td class="px-6 py-4 whitespace-nowrap">${item.precio_con_impuesto}</td>
            <td class="px-6 py-4 whitespace-nowrap">${item.tasa_impuesto}%</td>
            <td class="px-6 py-4 whitespace-nowrap subtotal">${item.precio_con_impuesto}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <button type="button" class="text-red-600 hover:text-red-900 eliminar-item">Eliminar</button>
            </td>
        `;
        itemsFactura.appendChild(newRow);

        // Agregar event listener para eliminar item
        newRow.querySelector('.eliminar-item').addEventListener('click', () => eliminarItem(newRow));
    }

    function eliminarItem(row) {
        row.remove();
    }

    function cerrarModalItem() {
        itemModal.classList.add('hidden');
    }

    function toggleInventarioSection() {
        const inventarioSection = document.getElementById('inventario-section');
        if (itemTipo.value === 'producto') {
            inventarioSection.classList.remove('hidden');
        } else {
            inventarioSection.classList.add('hidden');
        }
    }

    function limpiarFormulario() {
        document.getElementById('factura-form').reset();
        limpiarItemsFactura();
    }

    function limpiarItemsFactura() {
        document.getElementById('items-factura').innerHTML = '';
    }

    function clonarFactura() {
        const form = document.getElementById('factura-form');
        const formData = new FormData(form);
        formData.set('id', lastFacturaId + 1);
        formData.set('fecha', new Date().toISOString().slice(0, 16));

        // Aquí iría la lógica para clonar la factura en el backend
        console.log('Factura clonada:', Object.fromEntries(formData));

        Swal.fire({
            title: 'Éxito',
            text: 'La factura ha sido clonada correctamente',
            icon: 'success',
            confirmButtonText: 'Ok'
        }).then(() => {
            toggleModal();
            buscarFacturas();
        });
    }

    function cancelarFactura() {
        Swal.fire({
            title: '¿Estás seguro?',
            text: "¿Deseas cancelar esta factura?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, cancelar',
            cancelButtonText: 'No, mantener'
        }).then((result) => {
            if (result.isConfirmed) {
                // Aquí iría la lógica para cancelar la factura en el backend
                console.log('Factura cancelada');

                Swal.fire(
                    'Cancelada',
                    'La factura ha sido cancelada.',
                    'success'
                ).then(() => {
                    toggleModal();
                    buscarFacturas();
                });
            }
        });
    }

    function generarReporte() {
        // Aquí iría la lógica para generar el reporte
        console.log('Generando reporte...');
        Swal.fire({
            title: 'Reporte generado',
            text: 'El reporte ha sido generado exitosamente',
            icon: 'success',
            confirmButtonText: 'Ok'
        });
    }

    function enviarEmail() {
        // Aquí iría la lógica para enviar el email
        console.log('Enviando email...');
        Swal.fire({
            title: 'Email enviado',
            text: 'El email ha sido enviado exitosamente',
            icon: 'success',
            confirmButtonText: 'Ok'
        });
    }

    // Inicializar la búsqueda de facturas al cargar la página
    buscarFacturas();
});
</script>
{% endblock %}