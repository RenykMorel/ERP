{% extends "base.html" %}

{% block title %}Panel de Administración - CalculAI{% endblock %}

{% block extra_css %}
<style>
    .admin-container {
        padding: 20px;
    }
    .admin-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    .admin-button {
        padding: 10px 15px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .admin-button:hover {
        background-color: #45a049;
    }
    .admin-section {
        display: none;
    }
    .company-form {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
    }
    .company-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    .company-table th, .company-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }
    .company-table th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    .btn {
        padding: 8px 12px;
        margin: 2px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .btn-create {
        background-color: #4CAF50;
        color: white;
    }
    .btn-block {
        background-color: #f44336;
        color: white;
    }
    .btn-activate {
        background-color: #2196F3;
        color: white;
    }
    .btn-delete {
        background-color: #ff9800;
        color: white;
    }
    .btn:hover {
        opacity: 0.8;
    }
    #error-message {
        color: red;
        margin-bottom: 10px;
    }
    #success-message {
        color: green;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <h1>Panel de Administración</h1>

    <div id="error-message"></div>
    <div id="success-message"></div>

    <div class="admin-buttons">
        <button class="admin-button" onclick="showSection('users-section')">Usuarios</button>
        <button class="admin-button" onclick="showSection('empresas-section')">Empresas</button>
        <button class="admin-button" onclick="showSection('roles-section')">Roles</button>
        <button class="admin-button" onclick="showSection('permissions-section')">Permisos</button>
        <button class="admin-button" onclick="showSection('subscription-plans-section')">Planes de Suscripción</button>
        <button class="admin-button" onclick="showSection('billing-section')">Facturación</button>
        <button class="admin-button" onclick="showSection('security-section')">Seguridad</button>
        <button class="admin-button" onclick="showSection('reports-section')">Reportes</button>
    </div>

    <div id="users-section" class="admin-section">
        <h2>Gestionar Usuarios</h2>
        <!-- Aquí irá el contenido de la gestión de usuarios -->
    </div>

    <div id="empresas-section" class="admin-section">
        <h2>Gestionar Empresas</h2>
        <form id="create-company-form" class="company-form">
            <input type="text" name="nombre" placeholder="Nombre de la empresa" required>
            <button type="submit" class="btn btn-create">Crear Empresa</button>
        </form>

        <table class="company-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="companies-list">
                {% for empresa in empresas %}
                <tr data-empresa-id="{{ empresa.id }}">
                    <td>{{ empresa.nombre }}</td>
                    <td>{{ empresa.estado }}</td>
                    <td>
                        <button class="btn {% if empresa.estado == 'activo' %}btn-block{% else %}btn-activate{% endif %}" onclick="toggleEmpresaStatus({{ empresa.id }})">
                            {% if empresa.estado == 'activo' %}Bloquear{% else %}Activar{% endif %}
                        </button>
                        <button class="btn btn-delete" onclick="deleteEmpresa({{ empresa.id }})">Eliminar</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="roles-section" class="admin-section">
        <h2>Gestionar Roles</h2>
        <!-- Aquí irá el contenido de la gestión de roles -->
    </div>

    <div id="permissions-section" class="admin-section">
        <h2>Gestionar Permisos</h2>
        <!-- Aquí irá el contenido de la gestión de permisos -->
    </div>

    <div id="subscription-plans-section" class="admin-section">
        <h2>Planes de Suscripción</h2>
        <!-- Aquí irá el contenido de los planes de suscripción -->
    </div>

    <div id="billing-section" class="admin-section">
        <h2>Facturación</h2>
        <!-- Aquí irá el contenido de la facturación -->
    </div>

    <div id="security-section" class="admin-section">
        <h2>Configuración de Seguridad</h2>
        <!-- Aquí irá el contenido de la configuración de seguridad -->
    </div>

    <div id="reports-section" class="admin-section">
        <h2>Reportes</h2>
        <!-- Aquí irá el contenido de los reportes -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    const successDiv = document.getElementById('success-message');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    setTimeout(() => {
        successDiv.style.display = 'none';
    }, 5000);
}

function showSection(sectionId) {
    document.querySelectorAll('.admin-section').forEach(section => {
        section.style.display = 'none';
    });
    document.getElementById(sectionId).style.display = 'block';
}

function createEmpresa(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    fetch("{{ url_for('admin.create_company') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.empresa) {
            const empresasList = document.getElementById('companies-list');
            const newRow = `
                <tr data-empresa-id="${data.empresa.id}">
                    <td>${data.empresa.nombre}</td>
                    <td>${data.empresa.estado}</td>
                    <td>
                        <button class="btn btn-block" onclick="toggleEmpresaStatus(${data.empresa.id})">Bloquear</button>
                        <button class="btn btn-delete" onclick="deleteEmpresa(${data.empresa.id})">Eliminar</button>
                    </td>
                </tr>
            `;
            empresasList.insertAdjacentHTML('beforeend', newRow);
            form.reset();
            showSuccess('Empresa creada exitosamente');
        } else {
            showError(data.error || 'Error al crear la empresa');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error al crear la empresa');
    });
}

function toggleEmpresaStatus(empresaId) {
    fetch("{{ url_for('admin.toggle_company_status', empresa_id=0) }}".replace('0', empresaId), {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            const row = document.querySelector(`tr[data-empresa-id="${empresaId}"]`);
            const statusCell = row.cells[1];
            const toggleButton = row.querySelector('.btn-block, .btn-activate');
            statusCell.textContent = data.estado;
            if (data.estado === 'activo') {
                toggleButton.textContent = 'Bloquear';
                toggleButton.classList.remove('btn-activate');
                toggleButton.classList.add('btn-block');
            } else {
                toggleButton.textContent = 'Activar';
                toggleButton.classList.remove('btn-block');
                toggleButton.classList.add('btn-activate');
            }
            showSuccess('Estado de la empresa actualizado exitosamente');
        } else {
            showError(data.error || 'Error al actualizar el estado de la empresa');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error al actualizar el estado de la empresa');
    });
}

function deleteEmpresa(empresaId) {
    if (confirm('¿Estás seguro de que quieres eliminar esta empresa?')) {
        fetch("{{ url_for('admin.delete_company', empresa_id=0) }}".replace('0', empresaId), {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                const row = document.querySelector(`tr[data-empresa-id="${empresaId}"]`);
                row.remove();
                showSuccess('Empresa eliminada exitosamente');
            } else {
                showError(data.error || 'Error al eliminar la empresa');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error al eliminar la empresa');
        });
    }
}

document.getElementById('create-company-form').addEventListener('submit', createEmpresa);

// Mostrar la sección de empresas por defecto
document.addEventListener('DOMContentLoaded', function() {
    showSection('empresas-section');
});
</script>
{% endblock %}