<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - CalculAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        .admin-section {
            display: none;
        }
        #empresas-section {
            display: block;
        }
        .action-button {
            transition: all 0.3s ease;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .action-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-md">
            <div class="p-4 text-xl font-bold text-gray-800">Panel de Administración</div>
            <nav class="mt-4" id="sidebar-nav">
                <!-- Sidebar buttons will be inserted here by JavaScript -->
            </nav>
        </aside>

        <!-- Main content -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto">
            <!-- Header -->
            <header class="bg-white shadow-sm">
                <div class="flex items-center justify-between px-4 py-3">
                    <button class="text-gray-500 focus:outline-none focus:text-gray-700" id="toggle-sidebar">
                        <i class="fas fa-bars w-6 h-6"></i>
                    </button>
                    <div class="flex items-center">
                        <button class="flex text-gray-600 focus:outline-none">
                            <i class="fas fa-bell w-6 h-6"></i>
                        </button>
                        <button class="flex items-center text-gray-600 focus:outline-none ml-4" id="user-menu-button">
                            <img class="h-8 w-8 rounded-full object-cover" src="https://via.placeholder.com/32" alt="Avatar">
                            <span class="ml-2">Admin</span>
                            <i class="fas fa-chevron-down w-4 h-4 ml-1"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="p-6">
                <h2 id="section-title" class="text-2xl font-semibold text-gray-800 mb-4">Empresas</h2>
                
                <!-- Empresas Section -->
                <div id="empresas-section" class="admin-section">
                    <div class="mb-4 flex flex-wrap items-center gap-4">
                        <button id="create-company-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">Crear Empresa</button>
                        <input type="text" id="company-name-search" placeholder="Buscar por nombre..." class="px-4 py-2 border rounded">
                        <input type="text" id="company-rnc-search" placeholder="Buscar por RNC..." class="px-4 py-2 border rounded">
                        <select id="company-status-filter" class="px-4 py-2 border rounded">
                            <option value="">Todos los estados</option>
                            <option value="activo">Activo</option>
                            <option value="inactivo">Inactivo</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nombre</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Teléfono</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Empresa</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Rol</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="companies-list">
                                <!-- Company rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="admin-section">
                    <div class="mb-4 flex flex-wrap items-center gap-4">
                        <button id="create-user-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">Crear Usuario</button>
                        <input type="text" id="user-search" placeholder="Buscar usuario..." class="px-4 py-2 border rounded">
                        <select id="user-role-filter" class="px-4 py-2 border rounded">
                            <option value="">Todos los roles</option>
                            <option value="Administrador">Administrador</option>
                            <option value="Usuario">Usuario</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nombre</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Teléfono</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Empresa</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Rol</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="users-list">
                                <!-- User rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Roles Section -->
                <div id="roles-section" class="admin-section">
                    <div class="mb-4 flex flex-wrap items-center gap-4">
                        <button id="create-role-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">Crear Rol</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nombre del Rol</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Descripción</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="roles-list">
                                <!-- Role rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Permissions Section -->
                <div id="permissions-section" class="admin-section">
                    <div class="mb-4 flex flex-wrap items-center gap-4">
                        <button id="create-permission-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">Crear Permiso</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Permiso</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Descripción</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Roles Asignados</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="permissions-list">
                                <!-- Permission rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Subscription Plans Section -->
                <div id="subscription-plans-section" class="admin-section">
                    <div class="mb-4 flex flex-wrap items-center gap-4">
                        <button id="create-plan-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">Crear Plan</button>
                    </div>
                    <div id="subscription-plans" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Subscription plan cards will be inserted here by JavaScript -->
                    </div>
                </div>

                <!-- Billing Section -->
                <div id="billing-section" class="admin-section">
                    <div class="mb-4 flex flex-wrap items-center gap-4">
                        <button id="create-invoice-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">Crear Factura</button>
                        <input type="text" id="invoice-search" placeholder="Buscar factura..." class="px-4 py-2 border rounded">
                        <select id="invoice-status-filter" class="px-4 py-2 border rounded">
                            <option value="">Todos los estados</option>
                            <option value="pagada">Pagada</option>
                            <option value="pendiente">Pendiente</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Factura #</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Empresa</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Monto</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                                    <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-list">
                                <!-- Invoice rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Security Section -->
                <div id="security-section" class="admin-section">
                    <h3 class="text-lg font-semibold mb-4">Configuración de Seguridad</h3>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="two-factor-auth" class="rounded">
                            <label for="two-factor-auth" class="text-sm font-medium">Habilitar autenticación de dos factores para todos los usuarios</label>
                        </div>
                        <div>
                            <label for="password-policy" class="block text-sm font-medium mb-1">Política de contraseñas</label>
                            <select id="password-policy" class="w-full px-3 py-2 border rounded">
                                <option value="standard">Estándar (8 caracteres mínimo)</option>
                                <option value="strong">Fuerte (12 caracteres, símbolos y números)</option>
                                <option value="very-strong">Muy fuerte (16 caracteres, símbolos, números y mayúsculas)</option>
                            </select>
                        </div>
                        <div>
                            <label for="session-timeout" class="block text-sm font-medium mb-1">Tiempo de expiración de sesión</label>
                            <select id="session-timeout" class="w-full px-3 py-2 border rounded">
                                <option value="30">30 minutos</option>
                                <option value="60">1 hora</option>
                                <option value="120">2 horas</option>
                                <option value="240">4 horas</option>
                            </select>
                        </div>
                        <button id="save-security-settings" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">Guardar Configuración</button>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports-section" class="admin-section">
                    <div class="mb-4 flex flex-wrap items-center gap-4">
                        <select id="report-type" class="px-4 py-2 border rounded">
                            <option value="users">Usuarios Activos</option>
                            <option value="revenue">Ingresos Totales</option>
                            <option value="companies">Nuevas Empresas</option>
                            <option value="tickets">Tickets de Soporte</option>
                        </select>
                        <button id="generate-report" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">Generar Reporte</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h4 class="font-semibold mb-2">Usuarios Activos</h4>
                            <p class="text-3xl font-bold text-blue-600">1,234</p>
                            <p class="text-sm text-gray-500">Último mes</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h4 class="font-semibold mb-2">Ingresos Totales</h4>
                            <p class="text-3xl font-bold text-green-600">$45,678</p>
                            <p class="text-sm text-gray-500">Último trimestre</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h4 class="font-semibold mb-2">Nuevas Empresas</h4>
                            <p class="text-3xl font-bold text-purple-600">57</p>
                            <p class="text-sm text-gray-500">Último mes</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h4 class="font-semibold mb-2">Tickets de Soporte</h4>
                            <p class="text-3xl font-bold text-yellow-600">89</p>
                            <p class="text-sm text-gray-500">Abiertos actualmente</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for creating/editing a company -->
    <div id="company-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Crear/Editar Empresa</h3>
                    <div class="mt-2 space-y-4">
                        <input type="text" id="company-name" class="w-full px-3 py-2 border rounded" placeholder="Nombre de la empresa" required>
                        <input type="text" id="company-rnc" class="w-full px-3 py-2 border rounded" placeholder="RNC" required>
                        <input type="text" id="company-address" class="w-full px-3 py-2 border rounded" placeholder="Dirección" required>
                        <input type="tel" id="company-phone" class="w-full px-3 py-2 border rounded" placeholder="Teléfono" required>
                        <input type="text" id="company-type" class="w-full px-3 py-2 border rounded" placeholder="Tipo de empresa" required>
                        <input type="text" id="company-representative" class="w-full px-3 py-2 border rounded" placeholder="Representante legal" required>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="save-company" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">Guardar</button>
                    <button type="button" id="cancel-company" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for company details -->
    <div id="company-details-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="details-modal-title">Detalles de la Empresa</h3>
                    <div id="company-details" class="mt-2 space-y-4">
                        <!-- Company details will be inserted here by JavaScript -->
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-details" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for creating/editing a user -->
    <!-- Modal para crear/editar un usuario -->
    <div id="user-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="user-modal-title">Crear/Editar Usuario</h3>
                    <div class="mt-2 space-y-4">
                        <input type="text" id="user-name" class="w-full px-3 py-2 border rounded" placeholder="Nombre" required>
                        <input type="text" id="user-last-name" class="w-full px-3 py-2 border rounded" placeholder="Apellido" required>
                        <input type="email" id="user-email" class="w-full px-3 py-2 border rounded" placeholder="Email" required>
                        <input type="tel" id="user-phone" class="w-full px-3 py-2 border rounded" placeholder="Teléfono" required>
                        <input type="text" id="user-address" class="w-full px-3 py-2 border rounded" placeholder="Dirección" required>
                        <input type="text" id="user-company" class="w-full px-3 py-2 border rounded" placeholder="Nombre de la empresa" required>
                        <input type="text" id="user-company-type" class="w-full px-3 py-2 border rounded" placeholder="Tipo de empresa" required>
                        <select id="user-role" class="w-full px-3 py-2 border rounded" required>
                            <option value="">Seleccione un rol principal</option>
                            <option value="usuario">Usuario</option>
                            <option value="administrador">Administrador</option>
                        </select>
                        <input type="password" id="user-password" class="w-full px-3 py-2 border rounded" placeholder="Contraseña (dejar en blanco para no cambiar)">
                        
                        <!-- Contenedor para los checkboxes de roles -->
                        <div class="mt-4">
                            <h4 class="text-md font-medium text-gray-700 mb-2">Roles adicionales</h4>
                            <div id="user-roles" class="space-y-2">
                                <!-- Los checkboxes de roles se insertarán aquí dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="save-user" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">Guardar</button>
                    <button type="button" id="cancel-user" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        // Sample data for users
        let users = [
            { id: 1, nombre: 'Juan Pérez', email: 'juan@example.com', rol: 'Administrador' },
            { id: 2, nombre: 'María González', email: 'maria@example.com', rol: 'Usuario' },
        ];

        // Sample data for roles
        let roles = ['Administrador', 'Gerente', 'Contador', 'Usuario Estándar', 'Invitado'];

        // Sample data for permissions
        let permissions = [
            { id: 1, nombre: 'Crear Usuarios', descripcion: 'Permite crear nuevos usuarios en el sistema', roles: ['Administrador', 'Gerente'] },
            { id: 2, nombre: 'Editar Empresas', descripcion: 'Permite modificar la información de las empresas', roles: ['Administrador', 'Contador'] },
            { id: 3, nombre: 'Ver Reportes', descripcion: 'Permite acceder a los reportes del sistema', roles: ['Administrador', 'Gerente', 'Contador'] },
        ];

        // Sample data for subscription plans
        let subscriptionPlans = [
            { name: 'Plan Básico', price: '$29.99/mes', features: ['Hasta 5 usuarios', 'Soporte por email', 'Actualizaciones mensuales'] },
            { name: 'Plan Pro', price: '$79.99/mes', features: ['Hasta 20 usuarios', 'Soporte prioritario', 'Actualizaciones semanales'] },
            { name: 'Plan Enterprise', price: '$199.99/mes', features: ['Usuarios ilimitados', 'Soporte 24/7', 'Actualizaciones en tiempo real'] },
        ];

        // Sample data for invoices
        let invoices = [
            { id: 'INV-001', empresa: 'Empresa A', fecha: '2023-05-01', monto: 299.99, estado: 'pagada' },
            { id: 'INV-002', empresa: 'Empresa B', fecha: '2023-05-15', monto: 79.99, estado: 'pendiente' },
        ];

        const sections = [
            { id: 'users-section', name: 'Usuarios', icon: 'fas fa-users' },
            { id: 'empresas-section', name: 'Empresas', icon: 'fas fa-building' },
            { id: 'roles-section', name: 'Roles', icon: 'fas fa-user-tag' },
            { id: 'permissions-section', name: 'Permisos', icon: 'fas fa-key' },
            { id: 'subscription-plans-section', name: 'Planes de Suscripción', icon: 'fas fa-credit-card' },
            { id: 'billing-section', name: 'Facturación', icon: 'fas fa-file-invoice-dollar' },
            { id: 'security-section', name: 'Seguridad', icon: 'fas fa-lock' },
            { id: 'reports-section', name: 'Reportes', icon: 'fas fa-chart-bar' },
        ];

        // Populate sidebar
        const sidebarNav = document.getElementById('sidebar-nav');
        sections.forEach(section => {
            const button = document.createElement('button');
            button.className = `flex items-center w-full px-4 py-2 text-left text-gray-600 hover:bg-gray-100`;
            button.innerHTML = `<i class="${section.icon} w-5 h-5 mr-2"></i>${section.name}`;
            button.onclick = () => showSection(section.id);
            sidebarNav.appendChild(button);
        });

        // Add "Inicio" button
        const inicioButton = document.createElement('a');
        inicioButton.href = '/';
        inicioButton.className = 'flex items-center w-full px-4 py-2 text-left text-gray-600 hover:bg-gray-100';
        inicioButton.innerHTML = '<i class="fas fa-home w-5 h-5 mr-2"></i>Inicio';
        sidebarNav.appendChild(inicioButton);

        function showSection(sectionId) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });
            const section = document.getElementById(sectionId);
            section.style.display = 'block';
            document.getElementById('section-title').textContent = sections.find(s => s.id === sectionId).name;
        
            if (sectionId === 'empresas-section') {
                renderCompanies();
            } else if (sectionId === 'users-section') {
                renderUsers();
            }
        }
        
        function updateRoleFilter() {
            fetch('/admin/roles')
                .then(response => response.json())
                .then(data => {
                    const roleFilter = document.getElementById('user-role-filter');
                    roleFilter.innerHTML = '<option value="">Todos los roles</option>';
                    data.roles.forEach(role => {
                        roleFilter.innerHTML += `<option value="${role.nombre}">${role.nombre}</option>`;
                    });
                })
                .catch(error => {
                    console.error('Error al cargar roles para el filtro:', error);
                });
        }
        
        // Llamar a esta función cuando se carga la página y después de crear/editar/eliminar roles
        document.addEventListener('DOMContentLoaded', updateRoleFilter);

        // Asegúrate de que esta función se llame solo una vez al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            showSection('empresas-section'); // O la sección que quieras mostrar por defecto
        });

        function renderCompanies(filteredCompanies = null) {
            const companiesList = document.getElementById('companies-list');
            companiesList.innerHTML = '<tr><td colspan="7" class="text-center py-4">Cargando...</td></tr>';
        
            const companiesToRender = filteredCompanies || fetch('/admin/companies').then(response => response.json()).then(data => data.companies);
        
            Promise.resolve(companiesToRender)
                .then(companies => {
                    companiesList.innerHTML = '';
                    companies.forEach(company => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">${company.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${company.nombre}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${company.rnc}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${company.telefono}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${company.estado}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button onclick="showCompanyDetails(${company.id})" class="action-button px-2 py-1 text-sm text-blue-600 hover:text-blue-900 bg-blue-100 rounded mr-1">Ver</button>
                                <button onclick="editCompany(${company.id})" class="action-button px-2 py-1 text-sm text-green-600 hover:text-green-900 bg-green-100 rounded mr-1">Editar</button>
                                <button onclick="toggleCompanyStatus(${company.id})" class="action-button px-2 py-1 text-sm ${company.estado === 'activo' ? 'text-red-600 hover:text-red-900 bg-red-100' : 'text-green-600 hover:text-green-900 bg-green-100'} rounded mr-1">${company.estado === 'activo' ? 'Desactivar' : 'Activar'}</button>
                                <button onclick="deleteCompany(${company.id})" class="action-button px-2 py-1 text-sm text-red-600 hover:text-red-900 bg-red-100 rounded">Eliminar</button>
                            </td>
                        `;
                        companiesList.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    companiesList.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-600">Error al cargar las empresas</td></tr>';
                });
        }
        
        
        
        function toggleAsistenteUsuario(usuarioId) {
            fetch(`/admin/toggle_asistente_usuario/${usuarioId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message);
                        renderUsers();  // Vuelve a renderizar la lista de usuarios para actualizar el botón
                    } else {
                        throw new Error(data.error || 'Error desconocido');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error al cambiar el estado del asistente', 'error');
                });
        }
        
        // Función principal para buscar y filtrar usuarios
        function searchAndFilterUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const roleFilter = document.getElementById('user-role-filter').value;
        
            fetch('/admin/users')
                .then(response => response.json())
                .then(data => {
                    const filteredUsers = data.users.filter(user => 
                        (user.nombre.toLowerCase().includes(searchTerm) || 
                         user.apellido.toLowerCase().includes(searchTerm) || 
                         user.email.toLowerCase().includes(searchTerm) || 
                         user.nombre_usuario.toLowerCase().includes(searchTerm)) &&
                        (roleFilter === '' || user.rol.toLowerCase() === roleFilter.toLowerCase())
                    );
                    renderUsers(filteredUsers);
                })
                .catch(error => {
                    console.error('Error al filtrar usuarios:', error);
                    showToast('Error al filtrar usuarios', 'error');
                });
        }

        // Función para configurar los listeners de búsqueda y filtrado
        function setupSearchAndFilterListeners() {
            // Listeners para usuarios
            const userSearch = document.getElementById('user-search');
            const userRoleFilter = document.getElementById('user-role-filter');

            if (userSearch && userRoleFilter) {
                userSearch.addEventListener('input', searchAndFilterUsers);
                userRoleFilter.addEventListener('change', searchAndFilterUsers);
            }

            // Listeners para empresas (mantenemos esto por si lo necesitas en el futuro)
            const companyNameSearch = document.getElementById('company-name-search');
            const companyRncSearch = document.getElementById('company-rnc-search');
            const companyStatusFilter = document.getElementById('company-status-filter');

            if (companyNameSearch && companyRncSearch && companyStatusFilter) {
                companyNameSearch.addEventListener('input', handleCompanySearch);
                companyRncSearch.addEventListener('input', handleCompanySearch);
                companyStatusFilter.addEventListener('change', handleCompanySearch);
            }
        }

        // Función para manejar la búsqueda de empresas (la mantenemos por si la necesitas)
        function handleCompanySearch() {
            // Implementa la lógica de búsqueda de empresas aquí
            console.log('Búsqueda de empresas no implementada');
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            setupSearchAndFilterListeners();
            renderUsers(); // Carga inicial de usuarios
        });

        // Función para renderizar usuarios (asegúrate de que esta función esté definida en tu código)
        function renderUsers(users) {
            // Implementa la lógica para mostrar los usuarios en la UI
            console.log('Renderizando usuarios:', users);
        }

        // Función para mostrar mensajes toast (asegúrate de que esta función esté definida en tu código)
        function showToast(message, type) {
            // Implementa la lógica para mostrar mensajes toast
            console.log(`Toast: ${message} (${type})`);
        }

        function renderRoles() {
            const rolesList = document.getElementById('roles-list');
            rolesList.innerHTML = '';
            roles.forEach((role, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${role}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="editRole(${index})" class="action-button px-2 py-1 text-sm text-blue-600 hover:text-blue-900 bg-blue-100 rounded mr-1">Editar</button>
                        <button onclick="deleteRole(${index})" class="action-button px-2 py-1 text-sm text-red-600 hover:text-red-900 bg-red-100 rounded">Eliminar</button>
                    </td>
                `;
                rolesList.appendChild(row);
            });
        }

        function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const roleFilter = document.getElementById('user-role-filter').value.toLowerCase();
        
            fetch('/admin/users')
                .then(response => response.json())
                .then(data => {
                    const filteredUsers = data.users.filter(user => 
                        (user.nombre.toLowerCase().includes(searchTerm) || 
                         user.apellido.toLowerCase().includes(searchTerm) || 
                         user.email.toLowerCase().includes(searchTerm)) &&
                        (roleFilter === '' || user.rol.toLowerCase() === roleFilter)
                    );
                    renderFilteredUsers(filteredUsers);
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Hubo un problema al buscar usuarios',
                    });
                });
        }
        
        function renderFilteredUsers(users) {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${user.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.nombre} ${user.apellido}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.telefono || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.nombre_empresa || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.rol}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="editUser(${user.id})" class="action-button px-2 py-1 text-sm text-blue-600 hover:text-blue-900 bg-blue-100 rounded mr-1">Editar</button>
                        <button onclick="deleteUser(${user.id})" class="action-button px-2 py-1 text-sm text-red-600 hover:text-red-900 bg-red-100 rounded">Eliminar</button>
                    </td>
                `;
                usersList.appendChild(row);
            });
        }
        
        // Agregar event listeners para la búsqueda y filtrado
        document.getElementById('user-search').addEventListener('input', searchUsers);
        document.getElementById('user-role-filter').addEventListener('change', searchUsers);

        function renderPermissions() {
            const permissionsList = document.getElementById('permissions-list');
            permissionsList.innerHTML = '';
            permissions.forEach(permission => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${permission.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${permission.nombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${permission.descripcion}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${permission.roles.join(', ')}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="editPermission(${permission.id})" class="action-button px-2 py-1 text-sm text-blue-600 hover:text-blue-900 bg-blue-100 rounded mr-1">Editar</button>
                        <button onclick="deletePermission(${permission.id})" class="action-button px-2 py-1 text-sm text-red-600 hover:text-red-900 bg-red-100 rounded">Eliminar</button>
                    </td>
                `;
                permissionsList.appendChild(row);
            });
        }

        function validateCompanyForm() {
            const requiredFields = ['company-name', 'company-rnc', 'company-address', 'company-phone'];
            for (let field of requiredFields) {
                if (!document.getElementById(field).value.trim()) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de validación',
                        text: 'Por favor, complete todos los campos requeridos.',
                    });
                    return false;
                }
            }
            return true;
        }
        
        // Modifica la función createCompany para incluir esta validación
        function createCompany() {
            if (!validateCompanyForm()) return;
            // ... resto del código de createCompany
        }

        function renderSubscriptionPlans() {
            const plansContainer = document.getElementById('subscription-plans');
            plansContainer.innerHTML = '';
            subscriptionPlans.forEach((plan, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow-md';
                card.innerHTML = `
                    <h4 class="text-xl font-semibold mb-2">${plan.name}</h4>
                    <p class="text-2xl font-bold mb-4">${plan.price}</p>
                    <ul class="space-y-2">
                        ${plan.features.map(feature => `<li>${feature}</li>`).join('')}
                    </ul>
                    <div class="mt-4">
                        <button onclick="editPlan(${index})" class="action-button px-2 py-1 text-sm text-blue-600 hover:text-blue-900 bg-blue-100 rounded mr-1">Editar</button>
                        <button onclick="deletePlan(${index})" class="action-button px-2 py-1 text-sm text-red-600 hover:text-red-900 bg-red-100 rounded">Eliminar</button>
                    </div>
                `;
                plansContainer.appendChild(card);
            });
        }

        function renderInvoices() {
            const invoicesList = document.getElementById('invoices-list');
            invoicesList.innerHTML = '';
            invoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${invoice.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${invoice.empresa}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${invoice.fecha}</td>
                    <td class="px-6 py-4 whitespace-nowrap">$${invoice.monto.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            invoice.estado === 'pagada' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                        }">${invoice.estado}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="viewInvoice('${invoice.id}')" class="action-button px-2 py-1 text-sm text-blue-600 hover:text-blue-900 bg-blue-100 rounded mr-1">Ver</button>
                        <button onclick="deleteInvoice('${invoice.id}')" class="action-button px-2 py-1 text-sm text-red-600 hover:text-red-900 bg-red-100 rounded">Eliminar</button>
                    </td>
                `;
                invoicesList.appendChild(row);
            });
        }

        function toggleCompanyStatus(id) {
            fetch(`/admin/toggle_company_status/${id}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                    } else {
                        showToast(`Estado de la empresa actualizado a ${data.estado}`);
                        renderCompanies();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error al cambiar el estado de la empresa', 'error');
                });
        }

        function deleteCompany(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esta acción",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/companies/${id}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                showToast(data.error, 'error');
                            } else {
                                showToast('Empresa eliminada exitosamente');
                                renderCompanies();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showToast('Error al eliminar la empresa', 'error');
                        });
                }
            })
        }

        function searchAndFilterCompanies() {
            const nameFilter = document.getElementById('company-name-search').value.toLowerCase();
            const rncFilter = document.getElementById('company-rnc-search').value.toLowerCase();
            const statusFilter = document.getElementById('company-status-filter').value.toLowerCase();
        
            fetch('/admin/companies')
                .then(response => response.json())
                .then(data => {
                    const filteredCompanies = data.companies.filter(company => 
                        company.nombre.toLowerCase().includes(nameFilter) &&
                        company.rnc.toLowerCase().includes(rncFilter) &&
                        (statusFilter === '' || company.estado.toLowerCase() === statusFilter)
                    );
                    renderCompanies(filteredCompanies);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error al filtrar empresas', 'error');
                });
        }
        
        // Función para cargar y mostrar roles
        function loadRoles() {
            fetch('/admin/roles')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const rolesList = document.getElementById('roles-list');
                    rolesList.innerHTML = '';
                    data.roles.forEach(role => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">${role.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${role.nombre}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${role.descripcion || 'Sin descripción'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button onclick="editRole(${role.id})" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 mr-2">Editar</button>
                                <button onclick="deleteRole(${role.id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Eliminar</button>
                            </td>
                        `;
                        rolesList.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'No se pudieron cargar los roles: ' + error.message, 'error');
                });
        }
        
        function createRole() {
            Swal.fire({
                title: 'Crear Nuevo Rol',
                html:
                    '<input id="swal-input1" class="swal2-input" placeholder="Nombre del rol">' +
                    '<input id="swal-input2" class="swal2-input" placeholder="Descripción del rol">',
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Crear',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const name = document.getElementById('swal-input1').value;
                    const description = document.getElementById('swal-input2').value;
                    if (!name.trim()) {
                        Swal.showValidationMessage('El nombre del rol es requerido');
                        return false;
                    }
                    return { nombre: name, descripcion: description };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/roles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(result.value),
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Éxito', data.message || 'Rol creado correctamente', 'success');
                            loadRoles();
                            updateRoleFilter();
                        } else {
                            throw new Error(data.error || 'Error desconocido al crear el rol');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Error al crear el rol: ' + error.message, 'error');
                    });
                }
            });
        }
        
        
        
        function deleteRole(roleId) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "Esta acción no se puede deshacer",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/roles/${roleId}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Eliminado', 'El rol ha sido eliminado', 'success');
                                loadRoles();
                                updateRoleFilter();
                            } else {
                                throw new Error(data.error || 'Error desconocido al eliminar el rol');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire('Error', 'Hubo un problema al eliminar el rol: ' + error.message, 'error');
                        });
                }
            });
        }
        
        
        
        document.addEventListener('DOMContentLoaded', function() {
            loadRoles();
            updateRoleFilter();
            document.getElementById('create-role-btn').addEventListener('click', createRole);
        });

        // Función para manejar la búsqueda de empresas
        function handleCompanySearch() {
            const nameFilter = document.getElementById('company-name-search').value.toLowerCase();
            const rncFilter = document.getElementById('company-rnc-search').value.toLowerCase();
            const statusFilter = document.getElementById('company-status-filter').value;

            fetch('/admin/companies')
                .then(response => response.json())
                .then(data => {
                    const filteredCompanies = data.companies.filter(company => 
                        company.nombre.toLowerCase().includes(nameFilter) &&
                        company.rnc.toLowerCase().includes(rncFilter) &&
                        (statusFilter === '' || company.estado === statusFilter)
                    );
                    renderCompanies(filteredCompanies);
                })
                .catch(error => {
                    console.error('Error al buscar empresas:', error);
                    showToast('Error al buscar empresas', 'error');
                });
        }

        // Llamar a la función de configuración cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            setupCompanySearchListeners();
            setupUserSearchListeners();
            showSection('empresas-section');  // O la sección que quieras mostrar por defecto
        });

        function showToast(message) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                icon: 'success',
                title: message
            });
        }

        // Modal functionality
        const companyModal = document.getElementById('company-modal');
        const createCompanyBtn = document.getElementById('create-company-btn');
        const saveCompanyBtn = document.getElementById('save-company');
        const cancelCompanyBtn = document.getElementById('cancel-company');
        const companyNameInput = document.getElementById('company-name');
        const companyRncInput = document.getElementById('company-rnc');
        const companyAddressInput = document.getElementById('company-address');
        const companyTypeInput = document.getElementById('company-type');
        const companyRepresentativeInput = document.getElementById('company-representative');

        let editingCompanyId = null;
        
        createCompanyBtn.onclick = () => {
            editingCompanyId = null;
            companyNameInput.value = '';
            companyRncInput.value = '';
            companyAddressInput.value = '';
            companyTypeInput.value = '';
            companyRepresentativeInput.value = '';
            document.getElementById('modal-title').textContent = 'Crear Nueva Empresa';
            companyModal.classList.remove('hidden');
        };
        document.getElementById('save-company').onclick = () => {
            if (editingCompanyId) {
                // Update existing company
                const companyData = {
                    nombre: document.getElementById('company-name').value,
                    rnc: document.getElementById('company-rnc').value,
                    direccion: document.getElementById('company-address').value,
                    telefono: document.getElementById('company-phone').value,
                    tipo: document.getElementById('company-type').value,
                    representante: document.getElementById('company-representative').value,
                };
        
                fetch(`/admin/companies/${editingCompanyId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(companyData),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                    } else {
                        showToast('Empresa actualizada exitosamente');
                        document.getElementById('company-modal').classList.add('hidden');
                        renderCompanies();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error al actualizar la empresa', 'error');
                });
            } else {
                // Create new company
                createCompany();
            }
        };
        
        function editCompany(id) {
            fetch(`/admin/companies/${id}`)
                .then(response => response.json())
                .then(company => {
                    editingCompanyId = id;
                    document.getElementById('company-name').value = company.nombre;
                    document.getElementById('company-rnc').value = company.rnc;
                    document.getElementById('company-address').value = company.direccion;
                    document.getElementById('company-phone').value = company.telefono;
                    document.getElementById('company-type').value = company.tipo;
                    document.getElementById('company-representative').value = company.representante;
                    document.getElementById('modal-title').textContent = 'Editar Empresa';
                    document.getElementById('company-modal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error al cargar los datos de la empresa', 'error');
                });
        }

        cancelCompanyBtn.onclick = () => {
            companyModal.classList.add('hidden');
        };

        saveCompanyBtn.onclick = () => {
            if (editingCompanyId) {
                // Update existing company
                const companyData = {
                    nombre: companyNameInput.value,
                    rnc: companyRncInput.value,
                    direccion: companyAddressInput.value,
                    tipo: companyTypeInput.value,
                    representante: companyRepresentativeInput.value,
                };
        
                fetch(`/admin/companies/${editingCompanyId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(companyData),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                    } else {
                        showToast('Empresa actualizada exitosamente');
                        companyModal.classList.add('hidden');
                        renderCompanies();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error al actualizar la empresa', 'error');
                });
            } else {
                // Create new company
                createCompany();
            }
        };

        function showCompanyDetails(id) {
            fetch(`/admin/companies/${id}`)
                .then(response => response.json())
                .then(company => {
                    const detailsContainer = document.getElementById('company-details');
                    detailsContainer.innerHTML = `
                        <p><strong>Nombre:</strong> ${company.nombre}</p>
                        <p><strong>RNC:</strong> ${company.rnc}</p>
                        <p><strong>Dirección:</strong> ${company.direccion}</p>
                        <p><strong>Teléfono:</strong> ${company.telefono}</p>
                        <p><strong>Tipo:</strong> ${company.tipo}</p>
                        <p><strong>Representante Legal:</strong> ${company.representante}</p>
                        <p><strong>Estado:</strong> ${company.estado}</p>
                    `;
                    document.getElementById('company-details-modal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error al cargar los detalles de la empresa', 'error');
                });
        }

        document.getElementById('close-details').onclick = () => {
            document.getElementById('company-details-modal').classList.add('hidden');
        };

        // Search and filter functionality
        function filterCompanies() {
            const nameFilter = document.getElementById('company-name-search').value.toLowerCase();
            const rncFilter = document.getElementById('company-rnc-search').value.toLowerCase();
            const statusFilter = document.getElementById('company-status-filter').value.toLowerCase();

            const filteredCompanies = companies.filter(company => 
                company.nombre.toLowerCase().includes(nameFilter) &&
                company.rnc.toLowerCase().includes(rncFilter) &&
                (statusFilter === '' || company.estado.toLowerCase() === statusFilter)
            );

            renderCompanies(filteredCompanies);
        }

        document.getElementById('company-name-search').addEventListener('input', filterCompanies);
        document.getElementById('company-rnc-search').addEventListener('input', filterCompanies);
        document.getElementById('company-status-filter').addEventListener('change', filterCompanies);

        // User management functions
        function editUser(id) {
            fetch(`/admin/users/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Usuario no encontrado');
                    }
                    return response.json();
                })
                .then(user => {
                    document.getElementById('user-name').value = user.nombre;
                    document.getElementById('user-last-name').value = user.apellido;
                    document.getElementById('user-email').value = user.email;
                    document.getElementById('user-phone').value = user.telefono;
                    document.getElementById('user-address').value = user.direccion;
                    document.getElementById('user-company').value = user.nombre_empresa;
                    document.getElementById('user-company-type').value = user.rnc_empresa;
                    document.getElementById('user-role').value = user.rol;
                    document.getElementById('user-password').value = '';
        
                    // Cargar los roles del usuario
                    loadUserRoles(id);
        
                    document.getElementById('user-modal-title').textContent = 'Editar Usuario';
                    document.getElementById('user-modal').classList.remove('hidden');
        
                    document.getElementById('save-user').onclick = function() {
                        updateUser(id);
                    };
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo cargar la información del usuario. Es posible que el usuario ya no exista.',
                    });
                    renderUsers(); // Actualizar la lista de usuarios
                });
        }
        
        function loadUserRoles(userId) {
            fetch('/admin/roles')
                .then(response => response.json())
                .then(rolesData => {
                    fetch(`/admin/users/${userId}`)
                        .then(response => response.json())
                        .then(userData => {
                            const roleCheckboxes = document.getElementById('user-roles');
                            roleCheckboxes.innerHTML = '';
                            rolesData.roles.forEach(role => {
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.id = `role-${role.id}`;
                                checkbox.name = 'user-roles';
                                checkbox.value = role.nombre;
                                checkbox.checked = userData.roles.includes(role.nombre);
                                
                                const label = document.createElement('label');
                                label.htmlFor = `role-${role.id}`;
                                label.textContent = role.nombre;
                                
                                roleCheckboxes.appendChild(checkbox);
                                roleCheckboxes.appendChild(label);
                            });
                        });
                })
                .catch(error => console.error('Error al cargar roles:', error));
        }
        
        function updateUser(userId) {
            const roles = Array.from(document.querySelectorAll('input[name="user-roles"]:checked'))
                              .map(checkbox => checkbox.value);
            
            const userData = {
                nombre: document.getElementById('user-name').value,
                apellido: document.getElementById('user-last-name').value,
                email: document.getElementById('user-email').value,
                telefono: document.getElementById('user-phone').value,
                direccion: document.getElementById('user-address').value,
                nombre_empresa: document.getElementById('user-company').value,
                rnc_empresa: document.getElementById('user-company-type').value,
                rol: document.getElementById('user-role').value,
                roles: roles
            };
        
            // Si se ha introducido una nueva contraseña, inclúyela en los datos
            const newPassword = document.getElementById('user-password').value;
            if (newPassword) {
                userData.password = newPassword;
            }
        
            fetch(`/admin/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error,
                    });
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'Éxito',
                        text: 'Usuario actualizado exitosamente',
                    });
                    document.getElementById('user-modal').classList.add('hidden');
                    renderUsers(); // Actualizar la lista de usuarios
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Hubo un problema al actualizar el usuario',
                });
            });
        }

        function deleteUser(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esta acción",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/users/${id}`, { method: 'DELETE' })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                Swal.fire(
                                    'Eliminado',
                                    data.message || 'El usuario ha sido eliminado.',
                                    'success'
                                );
                                const userRow = document.querySelector(`tr[data-user-id="${id}"]`);
                                if (userRow) {
                                    userRow.remove();
                                }
                            } else {
                                throw new Error(data.error || 'No se pudo eliminar el usuario');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire(
                                'Error',
                                'Hubo un problema al eliminar el usuario: ' + error.message,
                                'error'
                            );
                        });
                }
            });
        }
        
        let isCreatingCompany = false;

        function createCompany() {
            const companyData = {
                nombre: document.getElementById('company-name').value,
                rnc: document.getElementById('company-rnc').value,
                direccion: document.getElementById('company-address').value,
                telefono: document.getElementById('company-phone').value,
                tipo: document.getElementById('company-type').value,
                representante: document.getElementById('company-representative').value
            };
        
            fetch('/admin/companies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(companyData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Empresa creada exitosamente',
                        text: `Se ha creado la empresa ${companyData.nombre}`,
                    });
                    document.getElementById('company-modal').classList.add('hidden');
                    renderCompanies();
                } else {
                    throw new Error(data.error || 'Error desconocido al crear la empresa');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error al crear empresa',
                    text: error.message || 'Hubo un problema al crear la empresa. Por favor, inténtelo de nuevo.',
                });
            });
        }

// Modificar el evento del botón de guardar
document.getElementById('save-company').addEventListener('click', function(event) {
    event.preventDefault();  // Previene el comportamiento por defecto del botón
    if (!isCreatingCompany) {
        createCompany();
    }
});
        
        // Asegúrate de que esta línea esté presente en tu código
        document.getElementById('save-company').addEventListener('click', function() {
            this.disabled = true;  // Deshabilita el botón
            if (editingCompanyId) {
                // Código para actualizar una empresa existente
            } else {
                createCompany();
            }
            // Habilita el botón después de un breve retraso
            setTimeout(() => { this.disabled = false; }, 2000);
        });

        function refreshUserList() {
            fetch('/admin/users')
                .then(response => response.json())
                .then(data => {
                    const usersList = document.getElementById('users-list');
                    usersList.innerHTML = '';
                    data.users.forEach(user => {
                        const row = document.createElement('tr');
                        row.setAttribute('data-user-id', user.id);
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">${user.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.nombre} ${user.apellido}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.telefono || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.empresa || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.rol}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button onclick="editUser(${user.id})" class="action-button px-2 py-1 text-sm text-blue-600 hover:text-blue-900 bg-blue-100 rounded mr-1">Editar</button>
                                <button onclick="deleteUser(${user.id})" class="action-button px-2 py-1 text-sm text-red-600 hover:text-red-900 bg-red-100 rounded">Eliminar</button>
                            </td>
                        `;
                        usersList.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Hubo un problema al cargar los usuarios. Por favor, intenta de nuevo más tarde.',
                    });
                });
        }
        
        // Llamar a refreshUserList cuando se carga la página
        document.addEventListener('DOMContentLoaded', refreshUserList);

        // Role management functions
        function editRole(roleId) {
            fetch(`/admin/roles/${roleId}`)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 405) {
                            throw new Error('El método GET no está permitido para esta ruta. Verifica la configuración del servidor.');
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success || !data.rol) {
                        throw new Error('La respuesta del servidor no contiene la información del rol');
                    }
                    Swal.fire({
                        title: 'Editar Rol',
                        html:
                            `<input id="swal-input1" class="swal2-input" value="${data.rol.nombre}" placeholder="Nombre del rol">` +
                            `<input id="swal-input2" class="swal2-input" value="${data.rol.descripcion || ''}" placeholder="Descripción del rol">`,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'Actualizar',
                        cancelButtonText: 'Cancelar',
                        preConfirm: () => {
                            const name = document.getElementById('swal-input1').value;
                            const description = document.getElementById('swal-input2').value;
                            if (!name.trim()) {
                                Swal.showValidationMessage('El nombre del rol es requerido');
                                return false;
                            }
                            return { nombre: name, descripcion: description };
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            updateRole(roleId, result.value);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'No se pudo cargar la información del rol: ' + error.message, 'error');
                });
        }
        
        function updateRole(roleId, roleData) {
            fetch(`/admin/roles/${roleId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(roleData),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', 'Rol actualizado correctamente', 'success');
                    loadRoles();
                    updateRoleFilter();
                } else {
                    throw new Error(data.error || 'Error desconocido al actualizar el rol');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Error al actualizar el rol: ' + error.message, 'error');
            });
        }
        
        function updateRole(roleId, roleData) {
            fetch(`/admin/roles/${roleId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(roleData),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', 'Rol actualizado correctamente', 'success');
                    loadRoles();
                    updateRoleFilter();
                } else {
                    throw new Error(data.error || 'Error desconocido al actualizar el rol');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Error al actualizar el rol: ' + error.message, 'error');
            });
        }

        

        // Permission management functions
        function editPermission(id) {
            showToast('Función de editar permiso no implementada');
        }

        function deletePermission(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esta acción",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    permissions = permissions.filter(p => p.id !== id);
                    renderPermissions();
                    Swal.fire(
                        'Eliminado',
                        'El permiso ha sido eliminado.',
                        'success'
                    )
                }
            })
        }

        // Subscription plan management functions
        function editPlan(index) {
            showToast('Función de editar plan no implementada');
        }

        function deletePlan(index) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esta acción",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    subscriptionPlans.splice(index, 1);
                    renderSubscriptionPlans();
                    Swal.fire(
                        'Eliminado',
                        'El plan ha sido eliminado.',
                        'success'
                    )
                }
            })
        }

        // Invoice management functions
        function viewInvoice(id) {
            showToast('Función de ver factura no implementada');
        }

        function deleteInvoice(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esta acción",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    invoices = invoices.filter(i => i.id !== id);
                    renderInvoices();
                    Swal.fire(
                        'Eliminada',
                        'La factura ha sido eliminada.',
                        'success'
                    )
                }
            })
        }

        // Security settings
        document.getElementById('save-security-settings').addEventListener('click', function() {
            showToast('Configuración de seguridad guardada');
        });

        // Reports
        document.getElementById('generate-report').addEventListener('click', function() {
            const reportType = document.getElementById('report-type').value;
            showToast(`Generando reporte de ${reportType}`);
        });

        // Initial render
        renderCompanies();
        renderUsers();
        renderRoles();
        renderPermissions();
        renderSubscriptionPlans();
        renderInvoices();

        // Event listeners for create buttons
        document.getElementById('create-user-btn').addEventListener('click', function() {
            document.getElementById('user-name').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-role').value = 'usuario';
            document.getElementById('user-password').value = '';
            document.getElementById('user-modal-title').textContent = 'Crear Usuario';
            document.getElementById('user-modal').classList.remove('hidden');
        });

        document.getElementById('create-role-btn').addEventListener('click', function() {
            Swal.fire({
                title: 'Crear Nuevo Rol',
                html:
                    '<input id="swal-input1" class="swal2-input" placeholder="Nombre del rol">' +
                    '<input id="swal-input2" class="swal2-input" placeholder="Descripción del rol">',
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-input1').value,
                        document.getElementById('swal-input2').value
                    ]
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const [roleName, roleDescription] = result.value;
                    fetch('/admin/roles', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ nombre: roleName, descripcion: roleDescription }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Rol creado exitosamente',
                                text: `Se ha creado el rol ${roleName}`,
                            });
                            loadRoles();  // Asegúrate de que esta función esté definida para recargar la lista de roles
                        } else {
                            throw new Error(data.error || 'Error al crear el rol');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Hubo un problema al crear el rol: ' + error.message,
                        });
                    });
                }
            });
        });

        document.getElementById('create-permission-btn').addEventListener('click', function() {
            showToast('Función de crear permiso no implementada');
        });

        document.getElementById('create-plan-btn').addEventListener('click', function() {
            showToast('Función de crear plan no implementada');
        });

        document.getElementById('create-invoice-btn').addEventListener('click', function() {
            showToast('Función de crear factura no implementada');
        });

        // User modal functionality
        document.getElementById('save-user').addEventListener('click', function() {
            const userData = {
                nombre: document.getElementById('user-name').value,
                apellido: document.getElementById('user-last-name').value,
                email: document.getElementById('user-email').value,
                telefono: document.getElementById('user-phone').value,
                direccion: document.getElementById('user-address').value,
                nombre_empresa: document.getElementById('user-company').value,
                rnc_empresa: document.getElementById('user-company-type').value,
                nombre_usuario: document.getElementById('user-email').value,
                password: document.getElementById('user-password').value,
                rol: document.getElementById('user-role').value
            };
        
            fetch('/admin/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Usuario creado exitosamente',
                        text: `Se ha creado el usuario ${data.user.nombre_usuario}`,
                    });
                    document.getElementById('user-modal').classList.add('hidden');
                    renderUsers();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al crear usuario',
                        text: data.error || 'Hubo un problema al crear el usuario',
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Hubo un problema al conectar con el servidor',
                });
            });
        });

        document.getElementById('cancel-user').addEventListener('click', function() {
            document.getElementById('user-modal').classList.add('hidden');
        });

        // Toggle sidebar functionality
        document.getElementById('toggle-sidebar').addEventListener('click', function() {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('hidden');
        });

        // User menu dropdown functionality
        document.getElementById('user-menu-button').addEventListener('click', function() {
            // Implement user menu dropdown logic here
            showToast('User menu clicked');
        });
    </script>
</body>
</html>