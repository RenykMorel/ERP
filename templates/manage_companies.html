{% extends "base.html" %}

{% block title %}Administrar Empresas - CalculAI{% endblock %}

{% block extra_css %}
<style>
    .company-container {
        padding: 20px;
    }
    .company-form {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
    }
    .company-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    .company-table th, .company-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }
    .company-table th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    .btn {
        padding: 8px 12px;
        margin: 2px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .btn-create {
        background-color: #4CAF50;
        color: white;
    }
    .btn-block {
        background-color: #f44336;
        color: white;
    }
    .btn-activate {
        background-color: #2196F3;
        color: white;
    }
    .btn-delete {
        background-color: #ff9800;
        color: white;
    }
    .btn:hover {
        opacity: 0.8;
    }
    #error-message {
        color: red;
        margin-bottom: 10px;
    }
    #success-message {
        color: green;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="company-container">
    <h1>Administrar Empresas</h1>

    <div id="error-message"></div>
    <div id="success-message"></div>

    <form id="create-company-form" class="company-form">
        <input type="text" name="nombre" placeholder="Nombre de la empresa" required>
        <button type="submit" class="btn btn-create">Crear Empresa</button>
    </form>

    <table class="company-table">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="companies-list">
            {% for company in companies %}
            <tr data-company-id="{{ company.id }}">
                <td>{{ company.nombre }}</td>
                <td>{{ company.estado }}</td>
                <td>
                    <button class="btn {% if company.estado == 'activo' %}btn-block{% else %}btn-activate{% endif %}" onclick="toggleCompanyStatus({{ company.id }})">
                        {% if company.estado == 'activo' %}Bloquear{% else %}Activar{% endif %}
                    </button>
                    <button class="btn btn-delete" onclick="deleteCompany({{ company.id }})">Eliminar</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <a href="{{ url_for('admin.manage_users') }}" class="btn">Gestionar Usuarios</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    const successDiv = document.getElementById('success-message');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    setTimeout(() => {
        successDiv.style.display = 'none';
    }, 5000);
}

function createCompany(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    fetch("{{ url_for('admin.create_company') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.company) {
            const companiesList = document.getElementById('companies-list');
            const newRow = `
                <tr data-company-id="${data.company.id}">
                    <td>${data.company.nombre}</td>
                    <td>${data.company.estado}</td>
                    <td>
                        <button class="btn btn-block" onclick="toggleCompanyStatus(${data.company.id})">Bloquear</button>
                        <button class="btn btn-delete" onclick="deleteCompany(${data.company.id})">Eliminar</button>
                    </td>
                </tr>
            `;
            companiesList.insertAdjacentHTML('beforeend', newRow);
            form.reset();
            showSuccess('Empresa creada exitosamente');
        } else {
            showError(data.error || 'Error al crear la empresa');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error al crear la empresa');
    });
}

function toggleCompanyStatus(companyId) {
    fetch(`{{ url_for('admin.toggle_company_status', company_id=0) }}`.replace('0', companyId), {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`tr[data-company-id="${companyId}"]`);
            const statusCell = row.cells[1];
            const toggleButton = row.querySelector('.btn-block, .btn-activate');
            statusCell.textContent = data.estado;
            if (data.estado === 'activo') {
                toggleButton.textContent = 'Bloquear';
                toggleButton.classList.remove('btn-activate');
                toggleButton.classList.add('btn-block');
            } else {
                toggleButton.textContent = 'Activar';
                toggleButton.classList.remove('btn-block');
                toggleButton.classList.add('btn-activate');
            }
            showSuccess('Estado de la empresa actualizado exitosamente');
        } else {
            showError(data.error || 'Error al actualizar el estado de la empresa');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error al actualizar el estado de la empresa');
    });
}

function deleteCompany(companyId) {
    if (confirm('¿Estás seguro de que quieres eliminar esta empresa?')) {
        fetch(`{{ url_for('admin.delete_company', company_id=0) }}`.replace('0', companyId), {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.querySelector(`tr[data-company-id="${companyId}"]`);
                row.remove();
                showSuccess('Empresa eliminada exitosamente');
            } else {
                showError(data.error || 'Error al eliminar la empresa');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error al eliminar la empresa');
        });
    }
}

document.getElementById('create-company-form').addEventListener('submit', createCompany);
</script>
{% endblock %}